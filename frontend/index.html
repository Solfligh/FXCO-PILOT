<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FX Co-Pilot – AI Trade Validator</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Vercel serves frontend/public/* at / -->
  <link rel="icon" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: "Poppins", sans-serif;
      background-image: url("/images/bg_fx_4k.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-color: #05070b;
      padding-bottom: 90px;
    }

    .bg-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      pointer-events: none;
      z-index: -1;
    }

    .watermark {
      position: fixed;
      right: 32px;
      bottom: 32px;
      font-size: 15px;
      font-weight: 300;
      text-transform: uppercase;
      letter-spacing: 10px;
      user-select: none;
      pointer-events: none;
      z-index: 999;
      font-family: "Poppins", sans-serif;

      background: linear-gradient(to right, rgba(255,255,255,0.18), rgba(255,255,255,0.28), rgba(255,255,255,0.18));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;

      text-shadow: 0 0 12px rgba(255,255,255,0.08);
      filter: drop-shadow(0 0 1px rgba(0,0,0,0.4));
    }

    .topbar {
      width: 100%;
      padding: 12px 25px;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(8px);
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #dce1e7;
      font-size: 14px;
      position: sticky;
      top: 0;
      z-index: 900;
      box-shadow: 0 4px 18px rgba(0,0,0,0.4);
      gap: 12px;
      box-sizing: border-box;
    }

    .topbar-right {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .topbtn {
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
      color: #e5e7eb;
      font-weight: 700;
      font-size: 12px;
      padding: 8px 12px;
      border-radius: 12px;
      cursor: pointer;
      transition: 0.15s;
      white-space: nowrap;
    }
    .topbtn:hover { background: rgba(255,255,255,0.10); transform: translateY(-1px); }
    .topbtn.primary {
      border: 1px solid rgba(0,212,106,0.35);
      background: rgba(0,212,106,0.14);
      color: #b8ffdd;
    }
    .topbtn.warn {
      border: 1px solid rgba(251,191,36,0.35);
      background: rgba(251,191,36,0.14);
      color: #fff3c4;
    }

    .sessions span {
      margin-right: 20px;
      padding: 4px 10px;
      border-radius: 6px;
      font-weight: 500;
      white-space: nowrap;
    }

    .open { background: #00d46a22; color: #00d46a; }
    .closed { background: #ff444422; color: #ff7777; }

    .container {
      max-width: 1300px;
      margin: 50px auto;
      padding: 40px;
      border-radius: 18px;

      background: rgba(18,20,28,0.35);
      backdrop-filter: blur(18px);
      border: 1px solid rgba(255,255,255,0.05);
      box-shadow: 0 8px 35px rgba(0,0,0,0.5);

      display: flex;
      gap: 40px;
      box-sizing: border-box;
    }

    h1 {
      font-size: 38px;
      color: #ffffff;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .badge {
      background: #00d46a;
      padding: 4px 10px;
      font-weight: 600;
      color: black;
      font-size: 12px;
      border-radius: 8px;
    }

    .section { flex: 1; }

    label {
      color: #cfd3d8;
      margin-bottom: 6px;
      font-size: 14px;
      display: block;
    }

    select, textarea, input[type="file"], input[type="email"], input[type="text"] {
      width: 100%;
      padding: 12px;
      margin-bottom: 16px;
      border-radius: 8px;
      border: none;
      background: #0b0d14cc;
      backdrop-filter: blur(6px);
      color: #cfd3d8;
      font-size: 14px;
      box-sizing: border-box;
    }

    textarea { height: 110px; resize: none; }

    .btn {
      appearance: none;
      width: 100%;
      padding: 15px;
      border-radius: 10px;
      border: none;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      color: #fff;
      background: linear-gradient(90deg, #00d46a, #0ebb53);
      transition: 0.2s;
    }

    .btn:hover {
      transform: scale(1.03);
      box-shadow: 0 0 20px rgba(0,255,140,0.4);
    }

    .btn:disabled {
      cursor: not-allowed;
      opacity: 0.45;
      transform: none;
      box-shadow: none;
      background: linear-gradient(90deg, rgba(0,212,106,0.35), rgba(14,187,83,0.35));
    }

    /* rate limit + pay hint line */
    .rate-hint {
      margin-top: 10px;
      font-size: 12px;
      color: #ffd86b;
      opacity: 0.95;
      display: none;
    }

    .output-box {
      background: rgba(0,0,0,0.45);
      border-radius: 12px;
      padding: 20px;
      color: #dce1e7;
      min-height: 260px;
      overflow-y: auto;
      border: 1px solid rgba(255,255,255,0.05);
      backdrop-filter: blur(8px);
    }

    .title-small {
      color: #cfd3d8;
      opacity: 0.8;
      font-size: 15px;
      margin-bottom: 10px;
    }

    .hint-pill {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.04);
      color: #cbd5e1;
      font-size: 12px;
      line-height: 1.6;
    }
    .hint-pill strong { color: #ffffff; }

    .consent-row {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin: -6px 0 16px;
      padding: 12px 12px;
      border-radius: 12px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.06);
    }

    .consent-row input[type="checkbox"] {
      margin-top: 3px;
      width: 18px;
      height: 18px;
      accent-color: #00d46a;
    }

    .consent-text {
      color: #cbd5e1;
      font-size: 12px;
      line-height: 1.55;
    }

    .consent-text a {
      color: #93c5fd;
      text-decoration: none;
      font-weight: 700;
    }

    .consent-text a:hover { text-decoration: underline; }

    .consent-hint {
      margin-top: 6px;
      font-size: 12px;
      color: #ffd86b;
      display: none;
    }

    .fx-disclaimer {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 2147483647;
      background: rgba(10, 15, 20, 0.92);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255, 255, 255, 0.10);
      padding: 12px 16px;
      font-size: 12px;
      color: #cbd5e1;
      text-align: center;
    }

    .fx-disclaimer strong { color: #fbbf24; }

    .fx-legal {
      margin-top: 8px;
      display: inline-flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      opacity: 0.95;
    }

    .fx-legal a {
      color: #93c5fd;
      text-decoration: none;
      font-weight: 700;
    }

    .fx-legal a:hover { text-decoration: underline; }
    .fx-legal .sep { color: rgba(255,255,255,0.25); }

    .legal-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 2147483646;
      background: rgba(0,0,0,0.65);
      backdrop-filter: blur(4px);
    }

    .legal-modal {
      display: none;
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      z-index: 2147483647;
      max-width: 920px;
      width: 92%;
      max-height: 80vh;
      overflow: auto;
      border-radius: 18px;
      background: rgba(18,20,28,0.92);
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 12px 50px rgba(0,0,0,0.75);
      color: #cbd5e1;
    }

    .legal-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 16px 18px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }

    .legal-modal-title { font-weight: 800; color: #fff; letter-spacing: 0.2px; }

    .legal-close {
      cursor: pointer;
      border: none;
      background: rgba(255,255,255,0.08);
      color: #fff;
      border-radius: 12px;
      padding: 8px 12px;
      font-weight: 800;
    }

    .legal-close:hover { background: rgba(255,255,255,0.12); }

    .legal-modal-content {
      padding: 18px;
      font-size: 13px;
      line-height: 1.75;
    }

    .legal-modal-content h2 {
      color: #fff;
      margin: 18px 0 8px;
      font-size: 15px;
    }

    .legal-modal-content ul { padding-left: 18px; margin: 10px 0; }

    .legal-callout {
      border: 1px solid rgba(251,191,36,0.22);
      background: rgba(251,191,36,0.08);
      padding: 14px;
      border-radius: 14px;
      margin: 12px 0;
    }

    .legal-callout strong { color: #fbbf24; }

    .fx-ul {
      margin: 8px 0 0;
      padding-left: 18px;
      color: #cbd5e1;
      font-size: 13px;
      line-height: 1.6;
    }

    /* Pricing modal styles */
    .pricing-card {
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
      border-radius: 16px;
      padding: 16px;
    }
    .price-row {
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      margin-top: 10px;
    }
    .price {
      font-size: 28px;
      font-weight: 900;
      color: #ffffff;
    }
    .per {
      font-size: 12px;
      opacity: 0.85;
    }
    .pill {
      display:inline-flex;
      gap:8px;
      align-items:center;
      font-size: 12px;
      border: 1px solid rgba(0,212,106,0.35);
      background: rgba(0,212,106,0.12);
      color: #b8ffdd;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 800;
    }
    .muted { opacity: 0.85; }
    .small { font-size: 12px; line-height: 1.6; }

    /* Auth (OTP) modal bits */
    .auth-row {
      display:flex;
      gap:10px;
      align-items:center;
      margin-top: 10px;
    }
    .auth-row .topbtn { flex: 1; }
    .auth-status {
      margin-top: 10px;
      font-size: 12px;
      color: #ffd86b;
      opacity: 0.95;
      display:none;
    }
    .auth-ok { color: #b8ffdd; }
    .auth-danger { color: #ff9aa2; }

    /* ✅ Institutional Verdict Preview modal */
    .preview-backdrop {
      display:none;
      position: fixed;
      inset: 0;
      z-index: 2147483646;
      background: rgba(0,0,0,0.72);
      backdrop-filter: blur(6px);
    }

    .preview-modal{
      display:none;
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      z-index: 2147483647;
      width: min(760px, 92vw);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 18px 70px rgba(0,0,0,0.70);
      overflow: hidden;
      background: rgba(18,20,28,0.95);
      color: #e5e7eb;
    }

    .preview-head{
      padding: 16px 18px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }

    .preview-title{
      display:flex;
      flex-direction: column;
      gap: 3px;
      min-width: 0;
    }

    .preview-title b{
      font-size: 13px;
      letter-spacing: .2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .preview-title span{
      font-size: 12px;
      color: rgba(203,213,225,0.9);
    }

    .preview-body{
      padding: 16px 18px 18px;
    }

    .decision-banner{
      border-radius: 16px;
      padding: 14px 14px;
      border: 1px solid rgba(255,255,255,0.10);
      display:flex;
      gap: 12px;
      align-items:flex-start;
    }

    .decision-icon{
      width: 40px;
      height: 40px;
      border-radius: 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      font-size: 18px;
      border: 1px solid rgba(255,255,255,0.10);
      flex: 0 0 auto;
    }

    .decision-text b{
      display:block;
      font-size: 13px;
      letter-spacing: .25px;
    }
    .decision-text p{
      margin: 6px 0 0;
      font-size: 12px;
      line-height: 1.55;
      color: rgba(226,232,240,0.95);
    }

    .dec-ok{
      background: rgba(34,197,94,0.14);
      border-color: rgba(34,197,94,0.25);
    }
    .dec-ok .decision-icon{ background: rgba(34,197,94,0.22); color: #bbf7d0; }

    .dec-cond{
      background: rgba(245,158,11,0.14);
      border-color: rgba(245,158,11,0.26);
    }
    .dec-cond .decision-icon{ background: rgba(245,158,11,0.20); color: #fde68a; }

    .dec-wait{
      background: rgba(148,163,184,0.12);
      border-color: rgba(148,163,184,0.22);
    }
    .dec-wait .decision-icon{ background: rgba(148,163,184,0.18); color: #e2e8f0; }

    .dec-bad{
      background: rgba(239,68,68,0.12);
      border-color: rgba(239,68,68,0.24);
    }
    .dec-bad .decision-icon{ background: rgba(239,68,68,0.16); color: #fecaca; }

    .preview-grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 12px;
    }
    @media(max-width: 640px){
      .preview-grid{ grid-template-columns: 1fr; }
    }

    .preview-kpi{
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      background: rgba(255,255,255,0.04);
      padding: 12px;
    }
    .preview-kpi .k{
      font-size: 11px;
      color: rgba(203,213,225,0.85);
      margin-bottom: 6px;
      font-weight: 700;
      letter-spacing: .2px;
      text-transform: uppercase;
    }
    .preview-kpi .v{
      font-size: 14px;
      font-weight: 900;
      color: #fff;
    }
    .preview-kpi .s{
      margin-top: 6px;
      font-size: 11px;
      color: rgba(203,213,225,0.85);
      line-height: 1.4;
    }

    .preview-actions{
      display:flex;
      gap: 10px;
      margin-top: 14px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .preview-actions .topbtn{ padding: 10px 12px; border-radius: 12px; }

    @media(max-width: 900px){
      .container { flex-direction: column; margin: 20px; padding: 25px; }
      .sessions span { margin-right: 10px; }
      .topbar { padding: 12px 16px; }
    }

    @media(max-width: 620px){
      .sessions { display:none; }
    }
  </style>
</head>

<body>
  <div class="bg-overlay"></div>
  <div class="watermark">FX CO-PILOT • AI TRADE VALIDATOR</div>

  <div class="topbar">
    <div id="clock">Loading time...</div>

    <div class="sessions">
      <span id="london" class="closed">London</span>
      <span id="newyork" class="closed">New York</span>
      <span id="tokyo" class="closed">Tokyo</span>
    </div>

    <div class="topbar-right">
      <button id="viewReportBtn" class="topbtn primary" onclick="goToLastReport()" style="display:none;">View Report</button>
      <button id="trialBtn" class="topbtn warn" onclick="openAuth()">Start Free Trial</button>
      <button class="topbtn" onclick="openPricing()">Pricing</button>
    </div>
  </div>

  <div class="container">
    <div class="section">
      <h1>FX Co-Pilot <span class="badge">AI TRADE VALIDATOR</span></h1>
      <p style="color:#cfd3d8; margin-bottom:25px;">
        Upload a chart or paste a signal. AI analyzes structure, liquidity & probabilities.
      </p>

      <label>Pair Type</label>
      <select id="pairType">
        <option>Forex</option>
        <option>Gold</option>
        <option>Crypto</option>
        <option>Indices</option>
      </select>

      <label>Timeframe Mode</label>
      <select id="timeframe">
        <option>Scalp</option>
        <option>Intraday</option>
        <option>Swing</option>
      </select>

      <label>Chart (optional)</label>
      <input type="file" id="chart">

      <label>Your signal</label>
      <textarea id="signal" placeholder="Example: XAU/USD BUY 2034-2030 SL 2025 TP 2050"></textarea>

      <div class="consent-row">
        <input type="checkbox" id="acceptLegal" />
        <div class="consent-text">
          I accept the <a href="#" onclick="openLegal('terms');return false;">Terms</a> and
          <a href="#" onclick="openLegal('privacy');return false;">Privacy Policy</a>.
          <div id="consentHint" class="consent-hint">Please accept Terms & Privacy to enable analysis.</div>
        </div>
      </div>

      <button id="analyzeBtn" class="btn" onclick="analyze()" disabled>Analyze with AI</button>
      <div id="rateHint" class="rate-hint"></div>

      <div id="payHint" class="rate-hint" style="display:none;"></div>
    </div>

    <div class="section">
      <div class="title-small">Validation Status</div>
      <div id="result" class="output-box">
        <div class="hint-pill">
          <div>✅</div>
          <div>
            <strong>Reports now open in a dedicated page.</strong><br/>
            Run analysis to generate a professional validation report.
          </div>
        </div>
      </div>

      <div class="title-small" style="margin-top:20px;">Recent Reports (local)</div>
      <div id="history" class="output-box" style="min-height:120px;">
        <div style="opacity:0.9;">No reports yet.</div>
      </div>
    </div>
  </div>

  <footer class="fx-disclaimer">
    <p style="margin:0;">
      <strong>Disclaimer:</strong>
      FXCO-PILOT provides AI-assisted market analysis for
      <strong>educational and informational purposes only</strong>.
      It does <strong>not</strong> constitute financial, investment,
      or trading advice. Trading involves risk. Always do your own research.
    </p>

    <div class="fx-legal" aria-label="Legal links">
      <a href="#" onclick="openLegal('terms');return false;">Terms</a>
      <span class="sep">•</span>
      <a href="#" onclick="openLegal('privacy');return false;">Privacy</a>
    </div>
  </footer>

  <!-- Existing legal modal -->
  <div id="legalBackdrop" class="legal-backdrop"></div>
  <div id="legalModal" class="legal-modal" role="dialog" aria-modal="true" aria-labelledby="legalTitle">
    <div class="legal-modal-header">
      <div id="legalTitle" class="legal-modal-title">Legal</div>
      <button class="legal-close" onclick="closeLegal()">Close</button>
    </div>
    <div id="legalContent" class="legal-modal-content"></div>
  </div>

  <!-- Existing risk modal -->
  <div id="riskBackdrop" class="legal-backdrop"></div>
  <div id="riskModal" class="legal-modal" role="dialog" aria-modal="true" aria-labelledby="riskTitle">
    <div class="legal-modal-header">
      <div id="riskTitle" class="legal-modal-title">Risk Warning</div>
      <button class="legal-close" onclick="acknowledgeRisk()">I Understand</button>
    </div>

    <div class="legal-modal-content">
      <div class="legal-callout">
        <p style="margin:0;">
          <strong>Trading Risk Notice:</strong> Trading financial instruments (Forex, indices, crypto, metals) involves significant risk and may not be suitable for everyone.
          You can lose part or all of your capital.
        </p>
      </div>

      <h2>FXCO-PILOT is not financial advice</h2>
      <p>
        FXCO-PILOT provides AI-assisted analysis for <b>educational and informational purposes only</b>. It does <b>not</b> provide financial, investment, or trading advice.
        Any trade decision you make is solely your responsibility.
      </p>

      <h2>Use responsibly</h2>
      <ul>
        <li>Always do your own research and confirm with your strategy.</li>
        <li>Use risk management (position sizing, SL, and limits).</li>
        <li>Consider professional advice if needed.</li>
      </ul>

      <p style="margin-top:14px;opacity:0.9;">
        Click <b>“I Understand”</b> to continue.
      </p>
    </div>
  </div>

  <!-- Pricing modal -->
  <div id="pricingBackdrop" class="legal-backdrop"></div>
  <div id="pricingModal" class="legal-modal" role="dialog" aria-modal="true" aria-labelledby="pricingTitle">
    <div class="legal-modal-header">
      <div id="pricingTitle" class="legal-modal-title">Pricing</div>
      <button class="legal-close" onclick="closePricing()">Close</button>
    </div>

    <div class="legal-modal-content">
      <div class="pricing-card">
        <div class="pill">One Plan • Full Access</div>
        <h2 style="margin-top:12px;">Stop second-guessing trades.</h2>
        <p class="muted small" style="margin-top:8px;">
          FX Co-Pilot validates your signal with structure, liquidity and probability — fast.
          Pay once per month, use it every day.
        </p>

        <div class="price-row">
          <div>
            <div class="price" id="pricingAmount">₦10,000</div>
            <div class="per" id="pricingPer">per month</div>
          </div>
          <div class="pill" id="pricingStatus">Checking access…</div>
        </div>

        <ul class="fx-ul" style="margin-top:12px;">
          <li>Unlimited AI trade validations</li>
          <li>Structure + liquidity context</li>
          <li>Confidence scoring + invalidation warnings</li>
          <li>History of your recent analyses</li>
        </ul>

        <button class="btn" style="margin-top:14px;" onclick="startPaystackCheckout()">Pay with Paystack</button>
        <p class="small muted" style="margin-top:10px;">
          After payment, you’ll be returned here automatically and your access will unlock.
        </p>
      </div>
    </div>
  </div>

  <!-- Auth (OTP) modal -->
  <div id="authBackdrop" class="legal-backdrop"></div>
  <div id="authModal" class="legal-modal" role="dialog" aria-modal="true" aria-labelledby="authTitle">
    <div class="legal-modal-header">
      <div id="authTitle" class="legal-modal-title">Start Free Trial</div>
      <button class="legal-close" onclick="closeAuth()">Close</button>
    </div>

    <div class="legal-modal-content">
      <div class="legal-callout">
        <p style="margin:0;">
          <strong>Free Trial:</strong> Verify your email to start your 14-day trial.
        </p>
      </div>

      <label>Email</label>
      <input type="email" id="authEmail" placeholder="you@example.com" autocomplete="email" />

      <div class="auth-row">
        <button class="topbtn primary" onclick="authSendCode()">Send code</button>
        <button class="topbtn" onclick="authPasteSavedEmail()">Use saved</button>
      </div>

      <div style="height:10px"></div>

      <label>6-digit code</label>
      <input type="text" id="authCode" placeholder="123456" inputmode="numeric" maxlength="6" />

      <div class="auth-row">
        <button class="topbtn primary" onclick="authVerifyCode()">Verify & Start Trial</button>
        <button class="topbtn" onclick="authLogout()">Sign out</button>
      </div>

      <div id="authStatus" class="auth-status"></div>

      <div class="small muted" style="margin-top:12px;">
        Tip: After verifying, you can analyze right away. If your trial ends, you can unlock via Pricing.
      </div>
    </div>
  </div>

  <!-- ✅ Institutional Verdict Preview -->
  <div id="previewBackdrop" class="preview-backdrop"></div>
  <div id="previewModal" class="preview-modal" role="dialog" aria-modal="true" aria-labelledby="previewTitle">
    <div class="preview-head">
      <div class="preview-title">
        <b id="previewTitle">Desk Verdict Preview</b>
        <span id="previewMeta">—</span>
      </div>
      <button class="legal-close" onclick="closePreview()">Close</button>
    </div>

    <div class="preview-body">
      <div id="previewBanner" class="decision-banner dec-wait">
        <div class="decision-icon" id="previewIcon">⏸</div>
        <div class="decision-text">
          <b id="previewTier">WAIT (NO EDGE YET)</b>
          <p id="previewWhy">Loading…</p>
        </div>
      </div>

      <div class="preview-grid">
        <div class="preview-kpi">
          <div class="k">Edge Score</div>
          <div class="v" id="previewScore">—</div>
          <div class="s" id="previewBasis">—</div>
        </div>
        <div class="preview-kpi">
          <div class="k">Confidence</div>
          <div class="v" id="previewConf">—</div>
          <div class="s" id="previewSC">Strength: — • Clarity: —</div>
        </div>
        <div class="preview-kpi">
          <div class="k">R:R + Flags</div>
          <div class="v" id="previewRR">—</div>
          <div class="s" id="previewRiskFlags">—</div>
        </div>
      </div>

      <div id="previewBlocks" style="display:none;margin-top:12px;border:1px solid rgba(255,90,95,0.22);background:rgba(255,90,95,0.08);padding:12px;border-radius:14px;">
        <div style="font-weight:900;color:#ff9aa2;margin-bottom:4px;">Hard Blocks</div>
        <div id="previewBlocksList" style="font-size:12px;line-height:1.6;color:#ffd1d6;"></div>
      </div>

      <div class="preview-actions">
        <button class="topbtn" onclick="closePreview()">Stay Here</button>
        <button class="topbtn primary" onclick="openFullReport()">Open Full Report</button>
      </div>

      <div class="small muted" style="margin-top:10px; color: rgba(203,213,225,0.85);">
        Desk rule: we don’t auto-approve borderline setups. “Edge” must be clean.
      </div>
    </div>
  </div>

  <script>
    function updateClock() {
      const now = new Date();
      document.getElementById("clock").innerText = now.toUTCString().replace("GMT", "UTC");
      const hour = now.getUTCHours();
      function setStatus(id, open) { document.getElementById(id).className = open ? "open" : "closed"; }
      setStatus("london", hour >= 7 && hour < 16);
      setStatus("newyork", hour >= 12 && hour < 21);
      setStatus("tokyo", hour >= 0 && hour < 9);
    }
    updateClock();
    setInterval(updateClock, 1000);

    function clamp(n, min, max) { return Math.max(min, Math.min(max, Number(n || 0))); }

    function esc(s) {
      return String(s ?? "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
      }[m]));
    }

    /* Per-session client id */
    function getOrCreateClientId() {
      const key = "fxco_client_id_v1";
      try {
        let cid = localStorage.getItem(key);
        if (!cid) {
          if (window.crypto && crypto.randomUUID) cid = crypto.randomUUID();
          else cid = "cid-" + Math.random().toString(16).slice(2) + "-" + Date.now();
          localStorage.setItem(key, cid);
        }
        return cid.length > 128 ? cid.slice(0, 128) : cid;
      } catch {
        return "unknown";
      }
    }
    const FXCO_CLIENT_ID = getOrCreateClientId();

    /* Report storage */
    const REPORT_KEY = "fxcoReport";
    const REPORTS_LIST_KEY = "fxco_reports_list_v1"; // local history list

    function hasLastReport() {
      try { return !!sessionStorage.getItem(REPORT_KEY); } catch { return false; }
    }

    function goToLastReport() {
      window.location.href = "/result.html";
    }

    function updateViewReportButton() {
      const btn = document.getElementById("viewReportBtn");
      if (!btn) return;
      btn.style.display = hasLastReport() ? "inline-flex" : "none";
    }

    function addToLocalReportsList(report) {
      try {
        const raw = localStorage.getItem(REPORTS_LIST_KEY);
        const list = raw ? JSON.parse(raw) : [];
        const safeList = Array.isArray(list) ? list : [];

        const item = {
          ts: Date.now(),
          pairType: report?.pair_type || report?.pairType || "",
          timeframe: report?.timeframe || "",
          signal: report?.signal_input || report?.signal || "",
          decision: report?.analysis?.decision || report?.decision || report?.analysis?.verdict || ""
        };

        safeList.unshift(item);
        const trimmed = safeList.slice(0, 8); // keep last 8
        localStorage.setItem(REPORTS_LIST_KEY, JSON.stringify(trimmed));
      } catch {}
    }

    function renderLocalHistory() {
      const box = document.getElementById("history");
      if (!box) return;

      let raw = "";
      try { raw = localStorage.getItem(REPORTS_LIST_KEY) || ""; } catch {}

      let list = [];
      try { list = raw ? JSON.parse(raw) : []; } catch { list = []; }
      if (!Array.isArray(list) || list.length === 0) {
        box.innerHTML = '<div style="opacity:0.9;">No reports yet.</div>';
        return;
      }

      box.innerHTML = list.map((r) => {
        const dt = new Date(r.ts || Date.now()).toLocaleString();
        const decision = esc(r.decision || "—");
        const meta = `${esc(r.pairType || "—")} • ${esc(r.timeframe || "—")}`;
        const sig = esc((r.signal || "").slice(0, 120));
        return `
          <div style="border-bottom:1px solid rgba(255,255,255,0.08);padding:12px 0;">
            <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;">
              <div style="font-weight:800;color:#fff;">${meta}</div>
              <div style="opacity:0.85;font-size:11px;white-space:nowrap;">${esc(dt)}</div>
            </div>
            <div style="margin-top:6px;opacity:0.9;font-size:12px;line-height:1.6;">
              <b>Decision:</b> ${decision}<br/>
              <b>Signal:</b> ${sig}${(r.signal||"").length>120 ? "…" : ""}
            </div>
          </div>
        `;
      }).join("");
    }

    /* Auth storage */
    const AUTH_TOKEN_KEY = "fxco_auth_token_v1";
    const AUTH_EMAIL_KEY = "fxco_auth_email_v1";
    const TRIAL_END_KEY  = "fxco_trial_end_v1";

    function getAuthToken() {
      try { return localStorage.getItem(AUTH_TOKEN_KEY) || ""; } catch { return ""; }
    }
    function getAuthEmail() {
      try { return localStorage.getItem(AUTH_EMAIL_KEY) || ""; } catch { return ""; }
    }
    function setAuth(email, token, trialEnds) {
      try {
        if (email) localStorage.setItem(AUTH_EMAIL_KEY, email);
        if (token) localStorage.setItem(AUTH_TOKEN_KEY, token);
        if (trialEnds) localStorage.setItem(TRIAL_END_KEY, String(trialEnds));
      } catch {}
    }
    function clearAuth() {
      try {
        localStorage.removeItem(AUTH_TOKEN_KEY);
        localStorage.removeItem(AUTH_EMAIL_KEY);
        localStorage.removeItem(TRIAL_END_KEY);
      } catch {}
    }

    function isTrialActiveLocal() {
      try {
        const end = Number(localStorage.getItem(TRIAL_END_KEY) || "0");
        if (!end) return false;
        return Date.now() < end * 1000;
      } catch { return false; }
    }

    function setAuthStatus(msg, kind) {
      const el = document.getElementById("authStatus");
      if (!el) return;
      if (!msg) { el.style.display = "none"; el.innerText = ""; el.className = "auth-status"; return; }
      el.style.display = "block";
      el.innerText = msg;
      el.className = "auth-status " + (kind || "");
    }

    function openAuth() {
      document.getElementById("authBackdrop").style.display = "block";
      document.getElementById("authModal").style.display = "block";
      const email = getAuthEmail();
      if (email) document.getElementById("authEmail").value = email;
      setAuthStatus("", "");
    }
    function closeAuth() {
      document.getElementById("authBackdrop").style.display = "none";
      document.getElementById("authModal").style.display = "none";
      setAuthStatus("", "");
    }
    document.getElementById("authBackdrop").addEventListener("click", closeAuth);

    function authPasteSavedEmail() {
      const e = getAuthEmail();
      if (e) document.getElementById("authEmail").value = e;
    }

    async function authSendCode() {
      const email = (document.getElementById("authEmail").value || "").trim().toLowerCase();
      if (!email || !email.includes("@")) {
        setAuthStatus("Enter a valid email.", "auth-danger");
        return;
      }
      setAuthStatus("Sending code…", "");
      try {
        const res = await fetch("/api/auth/start", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email })
        });
        const j = await res.json().catch(() => null);
        if (!res.ok || !j?.ok) {
          setAuthStatus("Failed: " + (j?.error || "Unable to send OTP."), "auth-danger");
          return;
        }
        try { localStorage.setItem(AUTH_EMAIL_KEY, email); } catch {}
        setAuthStatus("Code sent. Check your inbox (and spam).", "auth-ok");
      } catch (e) {
        setAuthStatus("Failed: " + (e?.message || "Network error"), "auth-danger");
      }
    }

    async function authVerifyCode() {
      const email = (document.getElementById("authEmail").value || "").trim().toLowerCase();
      const code = (document.getElementById("authCode").value || "").trim();
      if (!email || !email.includes("@")) {
        setAuthStatus("Enter a valid email.", "auth-danger");
        return;
      }
      if (!/^\d{6}$/.test(code)) {
        setAuthStatus("Enter the 6-digit code.", "auth-danger");
        return;
      }

      setAuthStatus("Verifying…", "");
      try {
        const res = await fetch("/api/auth/verify", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, code })
        });
        const j = await res.json().catch(() => null);
        if (!res.ok || !j?.ok || !j?.token) {
          setAuthStatus("Failed: " + (j?.error || "Verification failed."), "auth-danger");
          return;
        }
        setAuth(email, j.token, j.trial_ends || 0);
        setAuthStatus("Verified ✅ Trial active.", "auth-ok");
        updateTrialButton();
        applyPaymentGateUI();
        closeAuth();
      } catch (e) {
        setAuthStatus("Failed: " + (e?.message || "Network error"), "auth-danger");
      }
    }

    function authLogout() {
      clearAuth();
      updateTrialButton();
      applyPaymentGateUI();
      setAuthStatus("Signed out.", "auth-ok");
    }

    function updateTrialButton() {
      const btn = document.getElementById("trialBtn");
      if (!btn) return;

      const token = getAuthToken();
      const active = isTrialActiveLocal();

      if (token && active) {
        btn.innerText = "Trial Active ✅";
        btn.className = "topbtn primary";
      } else if (token && !active) {
        btn.innerText = "Trial Ended • Verify";
        btn.className = "topbtn warn";
      } else {
        btn.innerText = "Start Free Trial";
        btn.className = "topbtn warn";
      }
    }

    /* Payment state */
    const PAID_KEY = "fxco_paid_v1";
    const PAID_REF_KEY = "fxco_paid_ref_v1";
    let PAYSTACK_CONFIG = { ok:false };

    function setPayHint(msg, show=true) {
      const el = document.getElementById("payHint");
      if (!el) return;
      if (!show || !msg) { el.style.display = "none"; el.innerText = ""; return; }
      el.style.display = "block";
      el.innerText = msg;
    }

    function isPaid() {
      try { return localStorage.getItem(PAID_KEY) === "1"; } catch { return false; }
    }
    function getPaidRef() {
      try { return localStorage.getItem(PAID_REF_KEY) || ""; } catch { return ""; }
    }
    function setPaid(reference) {
      try {
        localStorage.setItem(PAID_KEY, "1");
        if (reference) localStorage.setItem(PAID_REF_KEY, reference);
      } catch {}
    }

    /* Rate limit UX */
    let rateTimer = null;
    function setRateHint(msg, show=true) {
      const el = document.getElementById("rateHint");
      if (!el) return;
      if (!show || !msg) {
        el.style.display = "none";
        el.innerText = "";
        return;
      }
      el.style.display = "block";
      el.innerText = msg;
    }

    function startRateCooldown(seconds) {
      const btn = document.getElementById("analyzeBtn");
      let remaining = Math.max(1, Number(seconds || 1));
      const accepted = document.getElementById("acceptLegal")?.checked;

      btn.disabled = true;
      setRateHint(`Rate limit hit. Try again in ${remaining}s…`, true);

      if (rateTimer) clearInterval(rateTimer);
      rateTimer = setInterval(() => {
        remaining -= 1;
        if (remaining <= 0) {
          clearInterval(rateTimer);
          rateTimer = null;
          setRateHint("", false);
          btn.disabled = !accepted;
          applyPaymentGateUI();
          return;
        }
        setRateHint(`Rate limit hit. Try again in ${remaining}s…`, true);
      }, 1000);
    }

    function setAnalyzeEnabled(enabled) {
      const btn = document.getElementById("analyzeBtn");
      const hint = document.getElementById("consentHint");
      btn.disabled = !enabled;
      hint.style.display = enabled ? "none" : "block";
    }

    function initConsentGate() {
      const cb = document.getElementById("acceptLegal");
      if (!cb) return;

      try {
        const saved = localStorage.getItem("fxco_accept_legal_v1");
        if (saved === "1") cb.checked = true;
      } catch {}

      setAnalyzeEnabled(cb.checked);

      cb.addEventListener("change", () => {
        if (rateTimer) {
          setAnalyzeEnabled(false);
        } else {
          setAnalyzeEnabled(cb.checked);
        }
        try { localStorage.setItem("fxco_accept_legal_v1", cb.checked ? "1" : "0"); } catch {}
        applyPaymentGateUI();
      });
    }

    /* Legal modal */
    function openLegal(which) {
      const backdrop = document.getElementById("legalBackdrop");
      const modal = document.getElementById("legalModal");
      const title = document.getElementById("legalTitle");
      const content = document.getElementById("legalContent");

      const updated = new Date().toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });

      const termsHtml = `
        <div class="legal-callout">
          <p style="margin:0;">
            <strong>Important:</strong> FXCO-PILOT provides AI-assisted market analysis for <strong>educational and informational purposes only</strong>.
            It does <strong>not</strong> provide financial, investment, or trading advice. Trading involves risk and you may lose money.
            <br/><br/>
            <strong>AI Confidence is not a guarantee.</strong>
          </p>
        </div>

        <p><b>Last updated:</b> ${updated}</p>

        <h2>1) Acceptance of Terms</h2>
        <p>By accessing or using FXCO-PILOT (the “Service”), you agree to these Terms. If you do not agree, do not use the Service.</p>

        <h2>2) No Financial Advice</h2>
        <p>The Service is not a broker, dealer, or financial advisor. Outputs may be inaccurate or unsuitable. You are solely responsible for your trading decisions and outcomes.</p>

        <h2>3) AI Outputs & Limitations</h2>
        <p>AI outputs are probabilistic. Any “confidence” score is an estimate, not a guarantee.</p>
      `;

      const privacyHtml = `
        <p><b>Last updated:</b> ${updated}</p>
        <h2>1) What We Collect</h2>
        <ul>
          <li><b>Inputs you provide:</b> signals you paste and optional chart uploads, processed to generate analysis.</li>
        </ul>
      `;

      if (which === "terms") {
        title.textContent = "Terms of Service";
        content.innerHTML = termsHtml;
      } else {
        title.textContent = "Privacy Policy";
        content.innerHTML = privacyHtml;
      }

      backdrop.style.display = "block";
      modal.style.display = "block";
    }
    function closeLegal() {
      document.getElementById("legalBackdrop").style.display = "none";
      document.getElementById("legalModal").style.display = "none";
    }
    document.getElementById("legalBackdrop").addEventListener("click", closeLegal);

    /* Risk modal */
    function showRiskModalIfNeeded() {
      try {
        const seen = localStorage.getItem("fxco_risk_ack_v1");
        if (seen === "1") return;
        document.getElementById("riskBackdrop").style.display = "block";
        document.getElementById("riskModal").style.display = "block";
        document.body.style.overflow = "hidden";
      } catch {
        document.getElementById("riskBackdrop").style.display = "block";
        document.getElementById("riskModal").style.display = "block";
        document.body.style.overflow = "hidden";
      }
    }
    function acknowledgeRisk() {
      try { localStorage.setItem("fxco_risk_ack_v1", "1"); } catch {}
      document.getElementById("riskBackdrop").style.display = "none";
      document.getElementById("riskModal").style.display = "none";
      document.body.style.overflow = "";
    }
    document.getElementById("riskBackdrop").addEventListener("click", (e) => { e.preventDefault(); e.stopPropagation(); });

    /* Pricing modal */
    function openPricing() {
      document.getElementById("pricingBackdrop").style.display = "block";
      document.getElementById("pricingModal").style.display = "block";
    }
    function closePricing() {
      document.getElementById("pricingBackdrop").style.display = "none";
      document.getElementById("pricingModal").style.display = "none";
    }
    document.getElementById("pricingBackdrop").addEventListener("click", closePricing);

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") { closeLegal(); closePricing(); closeAuth(); closePreview(); }
    });

    /* Paystack */
    function formatMoneyMinor(amountMinor, currency) {
      const amt = Number(amountMinor || 0);
      const cur = (currency || "NGN").toUpperCase();
      const major = amt / 100;
      try {
        return new Intl.NumberFormat(undefined, { style: "currency", currency: cur }).format(major);
      } catch {
        return `${cur} ${major.toFixed(2)}`;
      }
    }

    async function loadPaystackConfig() {
      try {
        const res = await fetch("/api/paystack/config");
        const j = await res.json();
        PAYSTACK_CONFIG = j || { ok:false };

        const amountEl = document.getElementById("pricingAmount");
        if (amountEl && j && typeof j.amount !== "undefined") {
          amountEl.innerText = formatMoneyMinor(j.amount, j.currency);
        }
        applyPaymentGateUI();
      } catch {
        applyPaymentGateUI();
      }
    }

    function applyPaymentGateUI() {
      const paid = isPaid();
      const accepted = document.getElementById("acceptLegal")?.checked;
      const requirePayment = !!PAYSTACK_CONFIG?.require_payment;

      const token = getAuthToken();
      const trialActive = token && isTrialActiveLocal();

      const statusEl = document.getElementById("pricingStatus");

      if (statusEl) {
        statusEl.innerText = paid ? "Active Access" : (trialActive ? "Trial Active" : (requirePayment ? "Locked" : "Optional"));
      }

      const btn = document.getElementById("analyzeBtn");
      if (!btn) return;
      if (rateTimer) return;

      if (requirePayment && !paid && !trialActive) {
        btn.disabled = true;
        if (accepted) {
          setPayHint("Start your free trial (verify email) or open Pricing to unlock.", true);
        }
        return;
      }

      setPayHint("", false);
      btn.disabled = !accepted;
    }

    async function startPaystackCheckout() {
      const emailSeed = getAuthEmail() || "";
      const email = (prompt("Enter your email for Paystack checkout:", emailSeed) || "").trim();
      if (!email || !email.includes("@")) {
        alert("Please enter a valid email.");
        return;
      }

      try {
        const res = await fetch("/api/paystack/init", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email })
        });

        const j = await res.json().catch(() => null);
        if (!res.ok || !j?.ok || !j?.authorization_url) {
          alert("Paystack init failed: " + (j?.error || "Unknown error"));
          return;
        }

        try { localStorage.setItem(PAID_REF_KEY, j.reference || ""); } catch {}
        window.location.href = j.authorization_url;
      } catch (e) {
        alert("Checkout failed: " + (e?.message || "Unknown error"));
      }
    }

    function getQueryParam(name) {
      const u = new URL(window.location.href);
      return u.searchParams.get(name);
    }

    async function verifyPaystackIfReturned() {
      const paystack = getQueryParam("paystack");
      const reference = getQueryParam("reference") || getQueryParam("trxref") || getPaidRef();

      if (paystack !== "success" || !reference) return;

      try {
        const statusEl = document.getElementById("pricingStatus");
        if (statusEl) statusEl.innerText = "Verifying payment…";

        const res = await fetch("/api/paystack/verify?reference=" + encodeURIComponent(reference));
        const j = await res.json().catch(() => null);

        if (res.ok && j?.ok && j?.paid) {
          setPaid(reference);
          alert("Payment verified. Access unlocked ✅");
        } else {
          alert("Payment not verified yet. If you were charged, refresh in a minute.");
        }

        const u = new URL(window.location.href);
        u.searchParams.delete("paystack");
        u.searchParams.delete("reference");
        u.searchParams.delete("trxref");
        window.history.replaceState({}, "", u.toString());
      } catch {
        // ignore
      } finally {
        applyPaymentGateUI();
      }
    }

    /* ✅ Institutional scoring helpers (1% desk model) */
    function parseRR(rr){
      if (rr === null || rr === undefined) return null;
      if (typeof rr === "number" && isFinite(rr)) return rr;
      const s = String(rr);
      const m = s.match(/(\d+(\.\d+)?)/);
      if (!m) return null;
      const n = Number(m[1]);
      return isFinite(n) ? n : null;
    }

    function computeInstitutionalVerdict(analysis){
      const a = analysis || {};
      const conf = clamp(a.confidence, 0, 100);

      // Backend strength/clarity might be 0..10 or 0..100. Normalize to 0..100.
      const strRaw = Number(a.strength ?? 0);
      const clrRaw = Number(a.clarity ?? 0);
      const str = clamp(strRaw <= 10 ? (strRaw * 10) : strRaw, 0, 100);
      const clr = clamp(clrRaw <= 10 ? (clrRaw * 10) : clrRaw, 0, 100);

      const rr = parseRR(a?.signal_check?.rr);
      const hasEntry = a?.signal_check?.entry != null;
      const hasSL = a?.signal_check?.stop_loss != null;
      const hasTP = Array.isArray(a?.signal_check?.targets) && a.signal_check.targets.length > 0;

      const inv = Array.isArray(a.invalidation_warnings) ? a.invalidation_warnings.filter(Boolean) : [];
      const invCount = inv.length;

      // --- Desk hard blocks (1% feel) ---
      const hardBlocks = [];
      if (!hasEntry || !hasSL || !hasTP) hardBlocks.push("Missing trade ticket fields (Entry/SL/TP).");
      if (rr !== null && rr < 1.5) hardBlocks.push("RR < 1.5 (fails minimum expectancy rule).");
      if (conf < 55) hardBlocks.push("Confidence < 55 (edge not proven).");
      if (invCount >= 2) hardBlocks.push("Multiple invalidation warnings (setup fragile).");

      const hardNo = hardBlocks.length > 0;

      // --- Edge score (desk weighting) ---
      const rrScore = (rr === null) ? 0 : clamp(((rr - 1.0) / 3.0) * 100, 0, 100);

      let score =
        (conf * 0.52) +
        (str * 0.16) +
        (clr * 0.22) +
        (rrScore * 0.10);

      // Penalties (risk flags / missing ticket)
      if (invCount >= 1) score -= 10;
      if (invCount >= 2) score -= 10;
      if (!hasEntry || !hasSL || !hasTP) score -= 12;

      score = clamp(score, 0, 100);

      // --- Tiering with desk language ---
      let tier = "WAIT";
      if (score >= 78 && !hardNo) tier = "EXECUTE";
      else if (score >= 62) tier = "EXECUTE-IF";
      else if (score >= 48) tier = "WAIT";
      else tier = "DO-NOT-TRADE";

      const reasons = [];
      reasons.push(`Edge ${Math.round(score)}/100`);
      reasons.push(`Conf ${Math.round(conf)}%`);
      if (rr !== null) reasons.push(`RR ${rr.toFixed(2)}`);
      reasons.push(`Strength ${Math.round(str)}/100`);
      reasons.push(`Clarity ${Math.round(clr)}/100`);
      if (invCount) reasons.push(`${invCount} flag${invCount>1?"s":""}`);

      let why = "";
      let action = "";

      if (tier === "EXECUTE") {
        why = "Edge is confirmed. Ticket is complete and risk flags are acceptable.";
        action = "Execute with defined size, hard SL, and no revenge entries.";
      } else if (tier === "EXECUTE-IF") {
        why = "Edge exists but needs confirmation. Conditions must be met before entry.";
        action = "Reduce size + require confirmation (break/close, sweep, or retest).";
      } else if (tier === "WAIT") {
        why = "No clear edge yet. Market context is not aligned or information is incomplete.";
        action = "Wait for alignment. Set alerts at key levels and reassess.";
      } else {
        why = "Fails desk rules (expectancy / completeness / risk flags).";
        action = "Stand down. Only re-enter the decision if setup materially improves.";
      }

      return {
        tier,
        score: Math.round(score),
        conf: Math.round(conf),
        str: Math.round(str),
        clr: Math.round(clr),
        rr,
        invCount,
        why,
        action,
        reasons,
        hardBlocks
      };
    }

    /* ✅ Preview modal controls */
    function openPreview() {
      document.getElementById("previewBackdrop").style.display = "block";
      document.getElementById("previewModal").style.display = "block";
      document.body.style.overflow = "hidden";
    }
    function closePreview() {
      document.getElementById("previewBackdrop").style.display = "none";
      document.getElementById("previewModal").style.display = "none";
      document.body.style.overflow = "";
    }
    document.getElementById("previewBackdrop").addEventListener("click", closePreview);

    function openFullReport(){
      closePreview();
      window.location.href = "/result.html";
    }

    /* Analyze */
    async function analyze() {
      const accepted = document.getElementById("acceptLegal")?.checked;
      if (!accepted) { setAnalyzeEnabled(false); return; }
      if (rateTimer) return;

      const trialActive = getAuthToken() && isTrialActiveLocal();
      if (PAYSTACK_CONFIG?.require_payment && !isPaid() && !trialActive) {
        openAuth();
        return;
      }

      setRateHint("", false);

      const pairTypeEl = document.getElementById("pairType");
      const timeframeEl = document.getElementById("timeframe");
      const signalEl = document.getElementById("signal");

      const pairType = (pairTypeEl?.value || "").trim();
      const timeframe = (timeframeEl?.value || "").trim();
      const signal = (signalEl?.value || "").trim();

      if (!pairType || !timeframe || !signal) {
        document.getElementById("result").innerHTML =
          "<b style='color:#ff6b6b'>Request failed:</b> Missing required fields. Please fill Pair Type, Timeframe Mode, and Your signal.";
        return;
      }

      const formData = new FormData();
      formData.append("pair_type", pairType);
      formData.append("timeframe", timeframe);
      formData.append("signal_input", signal);

      const file = document.getElementById("chart").files[0];
      if (file) formData.append("chart_image", file);

      const btn = document.getElementById("analyzeBtn");
      btn.disabled = true;
      document.getElementById("result").innerHTML = "Analyzing…";

      try {
        const headers = { "X-FXCO-Client": FXCO_CLIENT_ID };

        const token = getAuthToken();
        if (token) headers["X-FXCO-Auth"] = token;

        const ref = getPaidRef();
        if (ref) headers["X-FXCO-Paystack-Ref"] = ref;

        const res = await fetch("/api/analyze", {
          method: "POST",
          body: formData,
          headers
        });

        const ct = res.headers.get("content-type") || "";

        const trialEndsHdr = res.headers.get("X-FXCO-Trial-Ends");
        if (trialEndsHdr) {
          const n = Number(trialEndsHdr);
          if (n) { try { localStorage.setItem(TRIAL_END_KEY, String(n)); } catch {} }
          updateTrialButton();
        }

        if (res.status === 429) {
          let retryAfter = Number(res.headers.get("Retry-After") || 0);
          let j = null;
          if (ct.includes("application/json")) {
            try { j = await res.json(); } catch {}
          } else {
            const t = await res.text().catch(() => "");
            j = { error: t || "Too many requests" };
          }
          const seconds = Number((j && j.retry_after_seconds) || retryAfter || 10);
          document.getElementById("result").innerHTML =
            "<b style='color:#ffd86b'>Rate limit:</b> Too many requests. Please slow down.";
          startRateCooldown(seconds);
          btn.disabled = false;
          applyPaymentGateUI();
          return;
        }

        if (res.status === 402) {
          let j = null;
          if (ct.includes("application/json")) {
            try { j = await res.json(); } catch {}
          } else {
            const t = await res.text().catch(() => "");
            j = { error: t || "Access locked" };
          }
          document.getElementById("result").innerHTML =
            "<b style='color:#ffd86b'>Access locked:</b> " + esc(j?.error || "Payment required.") +
            "<br/><span style='opacity:0.9'>Start Trial (verify email) or open Pricing to unlock.</span>";
          btn.disabled = false;
          applyPaymentGateUI();
          openAuth();
          return;
        }

        if (res.status === 400) {
          let j = null;
          if (ct.includes("application/json")) {
            try { j = await res.json(); } catch {}
          } else {
            const t = await res.text().catch(() => "");
            j = { error: t || "Bad request" };
          }

          const missing = Array.isArray(j?.missing) ? j.missing.join(", ") : "";
          document.getElementById("result").innerHTML =
            "<b style='color:#ff6b6b'>Request failed (400):</b> " + esc(j?.error || "Bad request") +
            (missing ? `<br/><span style="opacity:0.9">Missing: ${esc(missing)}</span>` : "");
          btn.disabled = false;
          return;
        }

        if (!res.ok) {
          if (ct.includes("application/json")) {
            const j = await res.json().catch(() => null);
            throw new Error(j?.error || "Request failed.");
          }
          const t = await res.text().catch(() => "");
          throw new Error(t || "Request failed.");
        }

        if (!ct.includes("application/json")) {
          const t = await res.text().catch(() => "");
          throw new Error("Server did not return JSON. Got: " + t.slice(0, 120));
        }

        const data = await res.json();

        // Store for result page
        const reportPayload = {
          pair_type: pairType,
          timeframe: timeframe,
          signal_input: signal,
          analysis: data?.analysis || null,
          raw: data || null,
          generated_at: Date.now()
        };
        try { sessionStorage.setItem(REPORT_KEY, JSON.stringify(reportPayload)); } catch {}

        addToLocalReportsList(reportPayload);
        renderLocalHistory();
        updateViewReportButton();

        // ✅ Desk verdict
        const v = computeInstitutionalVerdict(reportPayload.analysis || {});

        // Ticket values for the status card
        const ticket = reportPayload.analysis?.signal_check || {};
        const entry = ticket.entry ?? "—";
        const sl = ticket.stop_loss ?? "—";
        const tp1 = (Array.isArray(ticket.targets) && ticket.targets[0] != null) ? ticket.targets[0] : "—";

        const tierColor =
          v.tier === "EXECUTE" ? "#00d46a" :
          v.tier === "EXECUTE-IF" ? "#fbbf24" :
          v.tier === "WAIT" ? "#94a3b8" :
          "#ff5a5f";

        const blocks = (v.hardBlocks || []).slice(0, 3).map(x => `<div style="margin-top:4px;opacity:0.95">• ${esc(x)}</div>`).join("");

        // Update status area (1% trade ticket)
        document.getElementById("result").innerHTML = `
          <div style="border:1px solid rgba(255,255,255,0.10);background:rgba(255,255,255,0.04);border-radius:16px;padding:16px;">
            <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start;flex-wrap:wrap;">
              <div style="font-weight:1000;color:${tierColor};letter-spacing:0.3px;font-size:14px;">
                ${esc(v.tier)} • EDGE ${esc(v.score)}/100
              </div>
              <div style="opacity:0.9;font-size:12px;line-height:1.5;">
                Conf ${esc(v.conf)}% ${v.rr !== null ? `• RR ${esc(v.rr.toFixed(2))}` : ""} • Flags ${esc(v.invCount)}
              </div>
            </div>

            <div style="margin-top:10px;display:grid;grid-template-columns:repeat(3,1fr);gap:10px;">
              <div style="border:1px solid rgba(255,255,255,0.10);border-radius:14px;padding:10px;background:rgba(0,0,0,0.18);">
                <div style="font-size:11px;opacity:0.85;">ENTRY</div>
                <div style="font-weight:900;color:#fff;margin-top:2px;">${esc(entry)}</div>
              </div>
              <div style="border:1px solid rgba(255,255,255,0.10);border-radius:14px;padding:10px;background:rgba(0,0,0,0.18);">
                <div style="font-size:11px;opacity:0.85;">STOP LOSS</div>
                <div style="font-weight:900;color:#fff;margin-top:2px;">${esc
