<!-- index.html (FULL FILE • UX UPGRADE: Signal Cleaner + premium submit flow; no features removed) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FX Co-Pilot AI Trade Validator</title>

  <!-- ✅ SEO -->
  <meta name="description" content="FX Co-Pilot is an AI trade validator. Upload a chart or paste a signal—get structure, liquidity context, risk checks, and a disciplined verdict before you enter." />
  <link rel="canonical" href="https://fxco-pilot.solflightech.org/" />
  <meta name="robots" content="index,follow" />

  <!-- ✅ Open Graph -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="FX Co-Pilot AI Trade Validator" />
  <meta property="og:description" content="Validate your trade before you enter. Structure + liquidity context, risk checks, and a disciplined verdict." />
  <meta property="og:url" content="https://fxco-pilot.solflightech.org/" />
  <meta property="og:image" content="https://fxco-pilot.solflightech.org/apple-touch-icon.png" />

  <!-- ✅ Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="FX Co-Pilot AI Trade Validator" />
  <meta name="twitter:description" content="Validate your trade before you enter. Structure + liquidity context, risk checks, and a disciplined verdict." />
  <meta name="twitter:image" content="https://fxco-pilot.solflightech.org/apple-touch-icon.png" />

  <!-- ✅ PWA / Install -->
  <meta name="theme-color" content="#05070b" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <!-- Vercel serves frontend/public/* at / -->
  <link rel="icon" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="manifest" href="/manifest.webmanifest">

  <!-- ✅ Sitemap -->
  <link rel="sitemap" type="application/xml" href="/sitemap.xml" />

  <!-- ✅ Fonts: FIX render-blocking + reduce CLS -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    rel="preload"
    as="style"
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=optional"
    onload="this.onload=null;this.rel='stylesheet'"
  />
  <noscript>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=optional">
  </noscript>

  <!-- ✅ Structured data (SEO) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "SoftwareApplication",
    "name": "FX Co-Pilot",
    "applicationCategory": "FinanceApplication",
    "operatingSystem": "Web",
    "description": "FX Co-Pilot is an AI trade validator. Upload a chart or paste a signal to get structure, liquidity context, risk checks, and a disciplined verdict before you enter.",
    "url": "https://fxco-pilot.solflightech.org/",
    "publisher": {
      "@type": "Organization",
      "name": "SolFligh Tech",
      "url": "https://www.solflightech.org/"
    }
  }
  </script>

  <style>
    .skip-link {
      position: absolute;
      left: -999px;
      top: 10px;
      z-index: 2147483647;
      background: #ffffff;
      color: #0b1220;
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 800;
      text-decoration: none;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    .skip-link:focus { left: 12px; outline: 3px solid rgba(0,212,106,0.6); }

    :focus-visible {
      outline: 3px solid rgba(147,197,253,0.65);
      outline-offset: 2px;
    }

    html { text-size-adjust: 100%; }
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Poppins", sans-serif;
      line-height: 1.45;
      font-size: 14px;

      background-color: #05070b;
      background-position: center;
      background-repeat: no-repeat;
      background-size: cover;
      background-image: image-set(
        url("/images/bg_fx_1280.webp") 1x,
        url("/images/bg_fx_1920.webp") 2x,
        url("/images/bg_fx_2560.webp") 3x
      );
      background-attachment: fixed;
      padding-bottom: 90px;
    }

    @media (max-width: 900px){
      body {
        background-image: none;
        background-color: #05070b;
        background-attachment: scroll;
      }
    }

    .bg-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      pointer-events: none;
      z-index: -1;
    }

    .watermark {
      position: fixed;
      right: 32px;
      bottom: 32px;
      font-size: 15px;
      font-weight: 300;
      text-transform: uppercase;
      letter-spacing: 10px;
      user-select: none;
      pointer-events: none;
      z-index: 999;

      background: linear-gradient(to right, rgba(255,255,255,0.18), rgba(255,255,255,0.28), rgba(255,255,255,0.18));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;

      text-shadow: 0 0 12px rgba(255,255,255,0.08);
      filter: drop-shadow(0 0 1px rgba(0,0,0,0.4));
    }

    .topbar {
      width: 100%;
      min-height: 52px;
      padding: 12px 25px;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(8px);
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #dce1e7;
      font-size: 14px;
      position: sticky;
      top: 0;
      z-index: 900;
      box-shadow: 0 4px 18px rgba(0,0,0,0.4);
      gap: 12px;
      box-sizing: border-box;
    }

    .topbar-right {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .topbtn {
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
      color: #e5e7eb;
      font-weight: 700;
      font-size: 12px;
      padding: 8px 12px;
      border-radius: 12px;
      cursor: pointer;
      transition: 0.15s;
      white-space: nowrap;
      line-height: 1;
    }
    .topbtn:hover { background: rgba(255,255,255,0.10); transform: translateY(-1px); }
    .topbtn.primary {
      border: 1px solid rgba(0,212,106,0.35);
      background: rgba(0,212,106,0.14);
      color: #b8ffdd;
    }
    .topbtn.warn {
      border: 1px solid rgba(251,191,36,0.35);
      background: rgba(251,191,36,0.14);
      color: #fff3c4;
    }
    .topbtn.install {
      border: 1px solid rgba(147,197,253,0.35);
      background: rgba(147,197,253,0.12);
      color: #dbeafe;
    }

    .sessions span {
      margin-right: 20px;
      padding: 4px 10px;
      border-radius: 6px;
      font-weight: 600;
      white-space: nowrap;
      line-height: 1.1;
    }
    .open { background: #00d46a22; color: #00d46a; }
    .closed { background: #ff444422; color: #ff7777; }

    .offline-banner {
      display:none;
      position: sticky;
      top: 52px;
      z-index: 899;
      margin: 10px auto 0;
      max-width: 1300px;
      padding: 10px 16px;
      background: rgba(251,191,36,0.16);
      border: 1px solid rgba(251,191,36,0.28);
      color: #fff3c4;
      border-radius: 14px;
      backdrop-filter: blur(8px);
      box-sizing: border-box;
    }

    .container {
      max-width: 1300px;
      margin: 50px auto;
      padding: 40px;
      border-radius: 18px;

      background: rgba(18,20,28,0.35);
      backdrop-filter: blur(18px);
      border: 1px solid rgba(255,255,255,0.05);
      box-shadow: 0 8px 35px rgba(0,0,0,0.5);

      display: flex;
      gap: 40px;
      box-sizing: border-box;
    }

    h1 {
      font-size: 38px;
      color: #ffffff;
      font-weight: 700;
      margin-bottom: 5px;
      line-height: 1.1;
    }

    .badge {
      background: #00d46a;
      padding: 4px 10px;
      font-weight: 700;
      color: black;
      font-size: 12px;
      border-radius: 8px;
      line-height: 1;
    }

    .section { flex: 1; }

    label {
      color: #cfd3d8;
      margin-bottom: 6px;
      font-size: 14px;
      display: block;
      line-height: 1.2;
    }

    select, textarea, input[type="file"], input[type="email"], input[type="text"] {
      width: 100%;
      padding: 12px;
      margin-bottom: 16px;
      border-radius: 8px;
      border: none;
      background: #0b0d14cc;
      backdrop-filter: blur(6px);
      color: #cfd3d8;
      font-size: 14px;
      box-sizing: border-box;
      font-family: inherit;
      line-height: 1.35;
    }

    textarea {
      height: 110px;
      min-height: 110px;
      max-height: 110px;
      resize: none;
    }

    /* ✅ UX: subtle field highlight when missing */
    .field-warn{
      box-shadow: 0 0 0 3px rgba(251,191,36,0.18);
      border-radius: 10px;
    }

    .btn {
      appearance: none;
      width: 100%;
      padding: 15px;
      border-radius: 12px;
      border: none;
      font-size: 18px;
      font-weight: 900;
      cursor: pointer;
      color: #fff;
      background: linear-gradient(90deg, #00d46a, #0ebb53);
      transition: 0.2s;
      line-height: 1.15;
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 22px rgba(0,255,140,0.35);
    }
    .btn:disabled {
      cursor: not-allowed;
      opacity: 0.45;
      transform: none;
      box-shadow: none;
      background: linear-gradient(90deg, rgba(0,212,106,0.35), rgba(14,187,83,0.35));
    }

    .rate-hint {
      margin-top: 10px;
      font-size: 12px;
      color: #ffd86b;
      opacity: 0.95;
      display: none;
      white-space: pre-wrap;
      line-height: 1.55;
    }

    .output-box {
      background: rgba(0,0,0,0.45);
      border-radius: 12px;
      padding: 20px;
      color: #dce1e7;
      min-height: 260px;
      overflow-y: auto;
      border: 1px solid rgba(255,255,255,0.05);
      backdrop-filter: blur(8px);
    }

    .title-small {
      color: #cfd3d8;
      opacity: 0.8;
      font-size: 15px;
      margin-bottom: 10px;
      line-height: 1.2;
    }

    .hint-pill {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.04);
      color: #cbd5e1;
      font-size: 12px;
      line-height: 1.6;
    }
    .hint-pill strong { color: #ffffff; }

    /* ✅ NEW: Signal Cleaner card */
    .signal-card{
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      border-radius: 16px;
      padding: 12px 12px;
      margin: -6px 0 16px;
      display: none;
    }
    .signal-card .row{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:center;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      color: #e5e7eb;
      line-height: 1;
    }
    .tag.ok{ border-color: rgba(0,212,106,0.30); background: rgba(0,212,106,0.10); color:#b8ffdd; }
    .tag.warn{ border-color: rgba(251,191,36,0.28); background: rgba(251,191,36,0.10); color:#fff3c4; }
    .tag.bad{ border-color: rgba(239,68,68,0.28); background: rgba(239,68,68,0.10); color:#fecaca; }
    .signal-meta{
      margin-top: 8px;
      font-size: 12px;
      color: rgba(203,213,225,0.9);
      line-height: 1.55;
    }
    .signal-actions{
      margin-top: 10px;
      display:flex;
      gap: 10px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .consent-row {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin: -6px 0 16px;
      padding: 12px 12px;
      border-radius: 12px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.06);
    }

    .consent-row input[type="checkbox"] {
      margin-top: 3px;
      width: 18px;
      height: 18px;
      accent-color: #00d46a;
      flex: 0 0 auto;
    }

    .consent-text {
      color: #cbd5e1;
      font-size: 12px;
      line-height: 1.55;
      min-width: 0;
    }

    .consent-label {
      display: inline-block;
      font-weight: 800;
      color: #e5e7eb;
      margin-bottom: 6px;
      line-height: 1.2;
    }

    .consent-links {
      display: inline-flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .consent-links a {
      color: #93c5fd;
      text-decoration: none;
      font-weight: 800;
    }
    .consent-links a:hover { text-decoration: underline; }

    .consent-hint {
      margin-top: 6px;
      font-size: 12px;
      color: #ffd86b;
      display: none;
    }

    .fx-disclaimer {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 2147483647;
      background: rgba(10, 15, 20, 0.92);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255, 255, 255, 0.10);
      padding: 12px 16px;
      font-size: 12px;
      color: #cbd5e1;
      text-align: center;
    }
    .fx-disclaimer strong { color: #fbbf24; }

    .fx-legal {
      margin-top: 8px;
      display: inline-flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      opacity: 0.95;
    }

    .fx-legal a {
      color: #93c5fd;
      text-decoration: none;
      font-weight: 700;
    }
    .fx-legal a:hover { text-decoration: underline; }
    .fx-legal .sep { color: rgba(255,255,255,0.25); }

    .legal-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 2147483646;
      background: rgba(0,0,0,0.65);
      backdrop-filter: blur(4px);
    }

    .legal-modal {
      display: none;
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      z-index: 2147483647;
      max-width: 920px;
      width: 92%;
      max-height: 80vh;
      overflow: auto;
      border-radius: 18px;
      background: rgba(18,20,28,0.92);
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 12px 50px rgba(0,0,0,0.75);
      color: #cbd5e1;
    }

    .legal-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 16px 18px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }

    .legal-modal-title { font-weight: 900; color: #fff; letter-spacing: 0.2px; }

    .legal-close {
      cursor: pointer;
      border: none;
      background: rgba(255,255,255,0.08);
      color: #fff;
      border-radius: 12px;
      padding: 8px 12px;
      font-weight: 900;
      line-height: 1;
    }

    .legal-close:hover { background: rgba(255,255,255,0.12); }

    .legal-modal-content {
      padding: 18px;
      font-size: 13px;
      line-height: 1.75;
    }

    .legal-modal-content h2 {
      color: #fff;
      margin: 18px 0 8px;
      font-size: 15px;
      line-height: 1.2;
    }

    .legal-modal-content ul { padding-left: 18px; margin: 10px 0; }

    .legal-callout {
      border: 1px solid rgba(251,191,36,0.22);
      background: rgba(251,191,36,0.08);
      padding: 14px;
      border-radius: 14px;
      margin: 12px 0;
    }

    .legal-callout strong { color: #fbbf24; }

    .fx-ul {
      margin: 8px 0 0;
      padding-left: 18px;
      color: #cbd5e1;
      font-size: 13px;
      line-height: 1.6;
    }

    .pricing-card {
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
      border-radius: 16px;
      padding: 16px;
    }
    .price-row {
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      margin-top: 10px;
    }
    .price {
      font-size: 28px;
      font-weight: 900;
      color: #ffffff;
      line-height: 1.1;
    }
    .per {
      font-size: 12px;
      opacity: 0.85;
      line-height: 1.2;
    }
    .pill {
      display:inline-flex;
      gap:8px;
      align-items:center;
      font-size: 12px;
      border: 1px solid rgba(0,212,106,0.35);
      background: rgba(0,212,106,0.12);
      color: #b8ffdd;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 900;
      line-height: 1;
      white-space: nowrap;
    }
    .muted { opacity: 0.85; }
    .small { font-size: 12px; line-height: 1.6; }

    .auth-row {
      display:flex;
      gap:10px;
      align-items:center;
      margin-top: 10px;
    }
    .auth-row .topbtn { flex: 1; }
    .auth-status {
      margin-top: 10px;
      font-size: 12px;
      color: #ffd86b;
      opacity: 0.95;
      display:none;
      line-height: 1.5;
    }
    .auth-ok { color: #b8ffdd; }
    .auth-danger { color: #ff9aa2; }

    .preview-backdrop {
      display:none;
      position: fixed;
      inset: 0;
      z-index: 2147483646;
      background: rgba(0,0,0,0.72);
      backdrop-filter: blur(6px);
    }

    .preview-modal{
      display:none;
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      z-index: 2147483647;
      width: min(760px, 92vw);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 18px 70px rgba(0,0,0,0.70);
      overflow: hidden;
      background: rgba(18,20,28,0.95);
      color: #e5e7eb;
    }

    .preview-head{
      padding: 16px 18px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }

    .preview-title{
      display:flex;
      flex-direction: column;
      gap: 3px;
      min-width: 0;
    }

    .preview-title b{
      font-size: 13px;
      letter-spacing: .2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.2;
    }

    .preview-title span{
      font-size: 12px;
      color: rgba(203,213,225,0.9);
      line-height: 1.2;
    }

    .preview-body{
      padding: 16px 18px 18px;
    }

    .decision-banner{
      border-radius: 16px;
      padding: 14px 14px;
      border: 1px solid rgba(255,255,255,0.10);
      display:flex;
      gap: 12px;
      align-items:flex-start;
    }

    .decision-icon{
      width: 40px;
      height: 40px;
      border-radius: 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      font-size: 18px;
      border: 1px solid rgba(255,255,255,0.10);
      flex: 0 0 auto;
      line-height: 1;
    }

    .decision-text b{
      display:block;
      font-size: 13px;
      letter-spacing: .25px;
      line-height: 1.2;
    }
    .decision-text p{
      margin: 6px 0 0;
      font-size: 12px;
      line-height: 1.55;
      color: rgba(226,232,240,0.95);
    }

    .dec-ok{
      background: rgba(34,197,94,0.14);
      border-color: rgba(34,197,94,0.25);
    }
    .dec-ok .decision-icon{ background: rgba(34,197,94,0.22); color: #bbf7d0; }

    .dec-cond{
      background: rgba(245,158,11,0.14);
      border-color: rgba(245,158,11,0.26);
    }
    .dec-cond .decision-icon{ background: rgba(245,158,11,0.20); color: #fde68a; }

    .dec-wait{
      background: rgba(148,163,184,0.12);
      border-color: rgba(148,163,184,0.22);
    }
    .dec-wait .decision-icon{ background: rgba(148,163,184,0.18); color: #e2e8f0; }

    .dec-bad{
      background: rgba(239,68,68,0.12);
      border-color: rgba(239,68,68,0.24);
    }
    .dec-bad .decision-icon{ background: rgba(239,68,68,0.16); color: #fecaca; }

    .preview-grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 12px;
    }
    @media(max-width: 640px){
      .preview-grid{ grid-template-columns: 1fr; }
    }

    .preview-kpi{
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      background: rgba(255,255,255,0.04);
      padding: 12px;
    }
    .preview-kpi .k{
      font-size: 11px;
      color: rgba(203,213,225,0.85);
      margin-bottom: 6px;
      font-weight: 800;
      letter-spacing: .2px;
      text-transform: uppercase;
      line-height: 1.2;
    }
    .preview-kpi .v{
      font-size: 14px;
      font-weight: 900;
      color: #fff;
      line-height: 1.2;
    }
    .preview-kpi .s{
      margin-top: 6px;
      font-size: 11px;
      color: rgba(203,213,225,0.85);
      line-height: 1.4;
    }

    .preview-actions{
      display:flex;
      gap: 10px;
      margin-top: 14px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .preview-actions .topbtn{ padding: 10px 12px; border-radius: 12px; }

    .ios-tip {
      display:none;
      position: fixed;
      left: 16px;
      right: 16px;
      bottom: 86px;
      z-index: 2147483647;
      background: rgba(18,20,28,0.92);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 16px;
      padding: 12px 14px;
      color: #e5e7eb;
      backdrop-filter: blur(10px);
      box-shadow: 0 12px 50px rgba(0,0,0,0.55);
    }

    @media(max-width: 900px){
      .container { flex-direction: column; margin: 20px; padding: 25px; }
      .sessions span { margin-right: 10px; }
      .topbar { padding: 12px 16px; }
    }
    @media(max-width: 620px){
      .sessions { display:none; }
    }
  </style>
</head>

<body>
  <a class="skip-link" href="#main">Skip to main content</a>

  <noscript>
    <div style="max-width:1300px;margin:12px auto;padding:12px 16px;border-radius:14px;border:1px solid rgba(251,191,36,0.28);background:rgba(251,191,36,0.16);color:#fff3c4;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;">
      JavaScript is required for FX Co-Pilot to run analysis, payments, and reports.
    </div>
  </noscript>

  <div class="bg-overlay"></div>
  <div class="watermark">FX CO-PILOT • AI TRADE VALIDATOR</div>

  <header class="topbar" role="banner" aria-label="Top bar">
    <div id="clock" aria-live="polite">Loading time...</div>

    <div class="sessions" aria-label="Market sessions">
      <span id="london" class="closed">London</span>
      <span id="newyork" class="closed">New York</span>
      <span id="tokyo" class="closed">Tokyo</span>
    </div>

    <div class="topbar-right" aria-label="Top actions">
      <button id="installAppBtn" class="topbtn install" onclick="installApp()" style="display:none;" aria-label="Install app">Install App</button>

      <button id="viewReportBtn" class="topbtn primary" onclick="goToLastReport()" style="display:none;" aria-label="View last report">View Report</button>
      <button id="trialBtn" class="topbtn warn" onclick="openAuth()" aria-label="Start free trial">Start Free Trial</button>
      <button class="topbtn" onclick="openPricing()" aria-label="Open pricing">Pricing</button>
      <a class="topbtn" href="/faq.html">FAQ</a>
      <a class="topbtn" href="/contact.html">Contact</a>
    </div>
  </header>

  <div id="offlineBanner" class="offline-banner" role="status" aria-live="polite">
    You’re offline. Analysis and payments may not work until you reconnect.
  </div>

  <main id="main" class="container" role="main">
    <div class="section">
      <h1>FX Co-Pilot <span class="badge">AI TRADE VALIDATOR</span></h1>
      <p style="color:#cfd3d8; margin-bottom:25px; line-height:1.55;">
        Upload a chart or paste a signal. AI analyzes structure, liquidity & probabilities.
      </p>

      <label for="pairType">Pair Type</label>
      <select id="pairType">
        <option>Forex</option>
        <option>Gold</option>
        <option>Crypto</option>
        <option>Indices</option>
      </select>

      <label for="timeframe">Trading Style</label>
      <select id="timeframe">
        <option>Scalp</option>
        <option>Intraday</option>
        <option>Swing</option>
      </select>

      <label for="chartTf">Chart Timeframe (what you’re on)</label>
      <select id="chartTf">
        <option value="">Select timeframe…</option>
        <option>1m</option>
        <option>3m</option>
        <option>5m</option>
        <option>15m</option>
        <option>30m</option>
        <option>45m</option>
        <option>1h</option>
        <option>2h</option>
        <option>4h</option>
        <option>1D</option>
        <option>1W</option>
      </select>
        </select>

      <label for="htfBias">Higher Timeframe Bias</label>
      <select id="htfBias">
      <option value="">Select HTF Bias…</option>
      <option>Bullish</option>
      <option>Bearish</option>
      <option>Range</option>
      <option>Unclear</option>
     </select>

      <label for="chart">Chart (optional)</label>
      <input type="file" id="chart" accept="image/*" />

      <label for="signal">Your signal</label>
      <textarea id="signal" placeholder="Example: XAU/USD BUY 2034-2030 SL 2025 TP 2050"></textarea>

      <!-- ✅ NEW: Signal Cleaner Preview -->
      <div id="signalCard" class="signal-card" role="region" aria-label="Signal preview">
        <div class="row" id="signalTags"></div>
        <div class="signal-meta" id="signalMeta"></div>
        <div class="signal-actions">
          <button class="topbtn" type="button" onclick="copyCleanSignal()">Copy Clean Signal</button>
          <button class="topbtn primary" type="button" onclick="focusMissingFromSignal()">Fix Missing</button>
        </div>
      </div>

      <div class="consent-row">
        <input type="checkbox" id="acceptLegal" name="acceptLegal" aria-describedby="consentHint" />
        <div class="consent-text">
          <label for="acceptLegal" class="consent-label">I accept the Terms and Privacy Policy.</label>
          <div class="consent-links" aria-label="Terms and privacy links">
            <a href="#" onclick="openLegal('terms');return false;">Terms</a>
            <span style="opacity:0.55;">•</span>
            <a href="#" onclick="openLegal('privacy');return false;">Privacy Policy</a>
          </div>
          <div id="consentHint" class="consent-hint">Please accept Terms & Privacy to enable analysis.</div>
        </div>
      </div>

      <button id="analyzeBtn" class="btn" onclick="analyze()" disabled>Validate Trade</button>
      <div id="rateHint" class="rate-hint" role="status" aria-live="polite"></div>
      <div id="payHint" class="rate-hint" style="display:none;" role="status" aria-live="polite"></div>

      <div style="margin-top:12px;opacity:0.85;font-size:12px;line-height:1.55;color:#cbd5e1;">
        Tip: Press <b>Ctrl / Cmd + Enter</b> to validate.
      </div>
    </div>

    <div class="section" aria-label="Results and reports">
      <div class="title-small">Validation Status</div>
      <div id="result" class="output-box" role="region" aria-label="Validation status output">
        <div class="hint-pill">
          <div aria-hidden="true">✅</div>
          <div>
            <strong>Reports open in a dedicated page.</strong><br/>
            Run analysis to generate a professional validation report.
          </div>
        </div>
      </div>

      <div class="title-small" style="margin-top:20px;">Recent Reports (local)</div>
      <div id="history" class="output-box" style="min-height:120px;" role="region" aria-label="Recent local reports">
        <div style="opacity:0.9;">No reports yet.</div>
      </div>
    </div>
  </main>

  <footer class="fx-disclaimer">
    <p style="margin:0; line-height:1.55;">
      <strong>Disclaimer:</strong>
      FXCO-PILOT provides AI-assisted market analysis for
      <strong>educational and informational purposes only</strong>.
      It does <strong>not</strong> constitute financial, investment,
      or trading advice. Trading involves risk. Always do your own research.
    </p>

    <div class="fx-legal" aria-label="Legal links">
      <a href="#" onclick="openLegal('terms');return false;">Terms</a>
      <span class="sep">•</span>
      <a href="#" onclick="openLegal('privacy');return false;">Privacy</a>
      <a href="/contact.html">Contact</a>
    </div>
  </footer>

  <!-- Legal modal -->
  <div id="legalBackdrop" class="legal-backdrop"></div>
  <div id="legalModal" class="legal-modal" role="dialog" aria-modal="true" aria-labelledby="legalTitle">
    <div class="legal-modal-header">
      <div id="legalTitle" class="legal-modal-title">Legal</div>
      <button class="legal-close" onclick="closeLegal()" aria-label="Close legal modal">Close</button>
    </div>
    <div id="legalContent" class="legal-modal-content"></div>
  </div>

  <!-- Risk modal -->
  <div id="riskBackdrop" class="legal-backdrop"></div>
  <div id="riskModal" class="legal-modal" role="dialog" aria-modal="true" aria-labelledby="riskTitle">
    <div class="legal-modal-header">
      <div id="riskTitle" class="legal-modal-title">Risk Warning</div>
      <button class="legal-close" onclick="acknowledgeRisk()" aria-label="Acknowledge risk and continue">I Understand</button>
    </div>

    <div class="legal-modal-content">
      <div class="legal-callout">
        <p style="margin:0;">
          <strong>Trading Risk Notice:</strong> Trading financial instruments (Forex, indices, crypto, metals) involves significant risk and may not be suitable for everyone.
          You can lose part or all of your capital.
        </p>
      </div>

      <h2>FXCO-PILOT is not financial advice</h2>
      <p>
        FXCO-PILOT provides AI-assisted analysis for <b>educational and informational purposes only</b>. It does <b>not</b> provide financial, investment, or trading advice.
        Any trade decision you make is solely your responsibility.
      </p>

      <h2>Use responsibly</h2>
      <ul>
        <li>Always do your own research and confirm with your strategy.</li>
        <li>Use risk management (position sizing, SL, and limits).</li>
        <li>Consider professional advice if needed.</li>
      </ul>

      <p style="margin-top:14px;opacity:0.9;">
        Click <b>“I Understand”</b> to continue.
      </p>
    </div>
  </div>

  <!-- Pricing modal -->
  <div id="pricingBackdrop" class="legal-backdrop"></div>
  <div id="pricingModal" class="legal-modal" role="dialog" aria-modal="true" aria-labelledby="pricingTitle">
    <div class="legal-modal-header">
      <div id="pricingTitle" class="legal-modal-title">Pricing</div>
      <button class="legal-close" onclick="closePricing()" aria-label="Close pricing modal">Close</button>
    </div>

    <div class="legal-modal-content">
      <div class="pricing-card">
        <div class="pill">One Plan • Full Access</div>
        <h2 style="margin-top:12px;">Stop second-guessing trades.</h2>
        <p class="muted small" style="margin-top:8px;">
          FX Co-Pilot validates your signal with structure, liquidity and probability — fast.
          Pay once per month, use it every day.
        </p>

        <div class="price-row">
          <div>
            <div class="price" id="pricingAmount">₦10,000</div>
            <div class="per" id="pricingPer">per month</div>
          </div>
          <div class="pill" id="pricingStatus" aria-live="polite">Checking access…</div>
        </div>

        <ul class="fx-ul" style="margin-top:12px;">
          <li>Unlimited AI trade validations</li>
          <li>Structure + liquidity context</li>
          <li>Confidence scoring + invalidation warnings</li>
          <li>History of your recent analyses</li>
        </ul>

        <button class="btn" style="margin-top:14px;" onclick="startPaystackCheckout()" aria-label="Pay with Paystack">Pay with Paystack</button>
        <p class="small muted" style="margin-top:10px;">
          After payment, you’ll be returned here automatically and your access will unlock.
        </p>
      </div>
    </div>
  </div>

  <!-- Auth (OTP) modal -->
  <div id="authBackdrop" class="legal-backdrop"></div>
  <div id="authModal" class="legal-modal" role="dialog" aria-modal="true" aria-labelledby="authTitle">
    <div class="legal-modal-header">
      <div id="authTitle" class="legal-modal-title">Start Free Trial</div>
      <button class="legal-close" onclick="closeAuth()" aria-label="Close start free trial modal">Close</button>
    </div>

    <div class="legal-modal-content">
      <div class="legal-callout">
        <p style="margin:0;">
          <strong>Free Trial:</strong> Verify your email to start your 14-day trial.
        </p>
      </div>

      <label for="authEmail">Email</label>
      <input type="email" id="authEmail" placeholder="you@example.com" autocomplete="email" />

      <div class="auth-row">
        <button class="topbtn primary" onclick="authSendCode()" aria-label="Send verification code">Send code</button>
        <button class="topbtn" onclick="authPasteSavedEmail()" aria-label="Use saved email">Use saved</button>
      </div>

      <div style="height:10px"></div>

      <label for="authCode">6-digit code</label>
      <input type="text" id="authCode" placeholder="123456" inputmode="numeric" maxlength="6" autocomplete="one-time-code" />

      <div class="auth-row">
        <button class="topbtn primary" onclick="authVerifyCode()" aria-label="Verify code and start trial">Verify & Start Trial</button>
        <button class="topbtn" onclick="authLogout()" aria-label="Sign out">Sign out</button>
      </div>

      <div id="authStatus" class="auth-status" role="status" aria-live="polite"></div>

      <div class="small muted" style="margin-top:12px;">
        Tip: After verifying, you can analyze right away. If your trial ends, you can unlock via Pricing.
      </div>
    </div>
  </div>

  <!-- ✅ Desk Verdict Preview -->
  <div id="previewBackdrop" class="preview-backdrop"></div>
  <div id="previewModal" class="preview-modal" role="dialog" aria-modal="true" aria-labelledby="previewTitle">
    <div class="preview-head">
      <div class="preview-title">
        <b id="previewTitle">Desk Verdict Preview</b>
        <span id="previewMeta">—</span>
      </div>
      <button class="legal-close" onclick="closePreview()" aria-label="Close preview">Close</button>
    </div>

    <div class="preview-body">
      <div id="previewBanner" class="decision-banner dec-wait">
        <div class="decision-icon" id="previewIcon">⏸</div>
        <div class="decision-text">
          <b id="previewTier">WAIT (NO EDGE YET)</b>
          <p id="previewWhy">Loading…</p>
        </div>
      </div>

      <div class="preview-grid">
        <div class="preview-kpi">
          <div class="k">Edge Score</div>
          <div class="v" id="previewScore">—</div>
          <div class="s" id="previewBasis">—</div>
        </div>
        <div class="preview-kpi">
          <div class="k">Confidence</div>
          <div class="v" id="previewConf">—</div>
          <div class="s" id="previewSC">Strength: — • Clarity: —</div>
        </div>
        <div class="preview-kpi">
          <div class="k">R:R + Flags</div>
          <div class="v" id="previewRR">—</div>
          <div class="s" id="previewRiskFlags">—</div>
        </div>
      </div>

      <div id="previewBlocks" style="display:none;margin-top:12px;border:1px solid rgba(255,90,95,0.22);background:rgba(255,90,95,0.08);padding:12px;border-radius:14px;">
        <div style="font-weight:900;color:#ff9aa2;margin-bottom:4px;">Hard Blocks</div>
        <div id="previewBlocksList" style="font-size:12px;line-height:1.6;color:#ffd1d6;"></div>
      </div>

      <div class="preview-actions">
        <button class="topbtn" onclick="closePreview()" aria-label="Close preview and stay here">Stay Here</button>
        <button class="topbtn primary" onclick="openFullReport()" aria-label="Open full report">Open Full Report</button>
      </div>

      <div class="small muted" style="margin-top:10px; color: rgba(203,213,225,0.85);">
        Desk rule: we don’t auto-approve borderline setups. “Edge” must be clean.
      </div>
    </div>
  </div>

  <!-- ✅ iOS Install Tip -->
  <div id="iosInstallTip" class="ios-tip">
    <div style="font-weight:900;margin-bottom:4px;">Install FXCO-PILOT on iPhone</div>
    <div style="font-size:12px;line-height:1.55;opacity:0.95;">
      Tap <b>Share</b> → <b>Add to Home Screen</b>.
    </div>
    <div style="margin-top:10px;display:flex;justify-content:flex-end;">
      <button class="topbtn" onclick="hideIosTip()" aria-label="Hide iOS install tip">Got it</button>
    </div>
  </div>

  <script>
    // -------------------------
    // ✅ API base helper
    // -------------------------
    const API_BASE = "";
    function apiUrl(path) {
      if (!API_BASE) return path;
      return API_BASE.replace(/\/$/, "") + path;
    }

    // -------------------------
    // PWA Install + Service Worker
    // -------------------------
    let __deferredPrompt = null;

    function isIos() { return /iphone|ipad|ipod/i.test(navigator.userAgent || ""); }
    function isSafari() {
      const ua = (navigator.userAgent || "").toLowerCase();
      return ua.includes("safari") && !ua.includes("chrome") && !ua.includes("crios") && !ua.includes("fxios");
    }
    function isInStandalone() {
      return window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone === true;
    }

    function showInstallButton(show) {
      const btn = document.getElementById("installAppBtn");
      if (!btn) return;
      btn.style.display = show ? "inline-flex" : "none";
    }

    function showIosTip() {
      const el = document.getElementById("iosInstallTip");
      if (!el) return;
      try {
        const seen = localStorage.getItem("fxco_ios_tip_seen_v1") === "1";
        if (seen) return;
      } catch {}
      el.style.display = "block";
    }

    function hideIosTip() {
      const el = document.getElementById("iosInstallTip");
      if (el) el.style.display = "none";
      try { localStorage.setItem("fxco_ios_tip_seen_v1", "1"); } catch {}
    }
    window.hideIosTip = hideIosTip;

    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      __deferredPrompt = e;
      showInstallButton(true);
    });

    window.addEventListener("appinstalled", () => {
      __deferredPrompt = null;
      showInstallButton(false);
    });

    async function installApp() {
      if (isIos() && isSafari() && !isInStandalone()) {
        showIosTip();
        return;
      }
      if (!__deferredPrompt) return;
      __deferredPrompt.prompt();
      try { await __deferredPrompt.userChoice; } catch {}
      __deferredPrompt = null;
      showInstallButton(false);
    }

    function registerServiceWorker() {
      if (!("serviceWorker" in navigator)) return;
      window.addEventListener("load", async () => {
        try {
          const reg = await navigator.serviceWorker.register("/sw.js");
          if (reg && reg.waiting) reg.waiting.postMessage({ type: "SKIP_WAITING" });
        } catch {}
      });
    }

    window.installApp = installApp;

    // -------------------------
    // Clock / Sessions
    // -------------------------
    function updateClock() {
      const now = new Date();
      document.getElementById("clock").innerText = now.toUTCString().replace("GMT", "UTC");
      const hour = now.getUTCHours();
      function setStatus(id, open) { document.getElementById(id).className = open ? "open" : "closed"; }
      setStatus("london", hour >= 7 && hour < 16);
      setStatus("newyork", hour >= 12 && hour < 21);
      setStatus("tokyo", hour >= 0 && hour < 9);
    }

    function clamp(n, min, max) { return Math.max(min, Math.min(max, Number(n || 0))); }

    function esc(s) {
      return String(s ?? "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
      }[m]));
    }

    // -------------------------
    // Offline banner
    // -------------------------
    function setOfflineUI() {
      const offline = !navigator.onLine;
      const b = document.getElementById("offlineBanner");
      if (b) b.style.display = offline ? "block" : "none";

      const btn = document.getElementById("analyzeBtn");
      if (btn && offline) btn.disabled = true;
      if (btn && !offline) applyPaymentGateUI();
    }
    window.addEventListener("online", setOfflineUI);
    window.addEventListener("offline", setOfflineUI);

    // -------------------------
    // Client ID
    // -------------------------
    function getOrCreateClientId() {
      const key = "fxco_client_id_v1";
      try {
        let cid = localStorage.getItem(key);
        if (!cid) {
          if (window.crypto && crypto.randomUUID) cid = crypto.randomUUID();
          else cid = "cid-" + Math.random().toString(16).slice(2) + "-" + Date.now();
          localStorage.setItem(key, cid);
        }
        return cid.length > 128 ? cid.slice(0, 128) : cid;
      } catch {
        return "unknown";
      }
    }
    const FXCO_CLIENT_ID = getOrCreateClientId();

    // -------------------------
    // Report storage
    // -------------------------
    const REPORT_KEY = "fxcoReport";
    const REPORTS_LIST_KEY = "fxco_reports_list_v1";

    function hasLastReport() {
      try { return !!sessionStorage.getItem(REPORT_KEY); } catch { return false; }
    }
    function goToLastReport() {
      window.location.href = "/result.html";
    }
    function updateViewReportButton() {
      const btn = document.getElementById("viewReportBtn");
      if (!btn) return;
      btn.style.display = hasLastReport() ? "inline-flex" : "none";
    }

    function addToLocalReportsList(report) {
      try {
        const raw = localStorage.getItem(REPORTS_LIST_KEY);
        const list = raw ? JSON.parse(raw) : [];
        const safeList = Array.isArray(list) ? list : [];

        const item = {
          ts: Date.now(),
          pairType: report?.pair_type || "",
          timeframe: report?.timeframe || "",
          chart_tf: report?.chart_tf || "",
          signal: report?.signal_input || "",
          decision: report?.analysis?.decision || report?.analysis?.verdict || ""
        };

        safeList.unshift(item);
        const trimmed = safeList.slice(0, 8);
        localStorage.setItem(REPORTS_LIST_KEY, JSON.stringify(trimmed));
      } catch {}
    }

    function renderLocalHistory() {
      const box = document.getElementById("history");
      if (!box) return;

      let raw = "";
      try { raw = localStorage.getItem(REPORTS_LIST_KEY) || ""; } catch {}

      let list = [];
      try { list = raw ? JSON.parse(raw) : []; } catch { list = []; }

      if (!Array.isArray(list) || list.length === 0) {
        box.innerHTML = '<div style="opacity:0.9;">No reports yet.</div>';
        return;
      }

      box.innerHTML = list.map((r) => {
        const dt = new Date(r.ts || Date.now()).toLocaleString();
        const decision = esc(r.decision || "—");
        const style = esc(r.timeframe || "—");
        const tf = esc(r.chart_tf || "—");
        const meta = `${esc(r.pairType || "—")} • ${style} • TF ${tf}`;
        const sig = esc((r.signal || "").slice(0, 120));
        return `
          <div style="border-bottom:1px solid rgba(255,255,255,0.08);padding:12px 0;">
            <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;">
              <div style="font-weight:900;color:#fff;">${meta}</div>
              <div style="opacity:0.85;font-size:11px;white-space:nowrap;">${esc(dt)}</div>
            </div>
            <div style="margin-top:6px;opacity:0.9;font-size:12px;line-height:1.6;">
              <b>Decision:</b> ${decision}<br/>
              <b>Signal:</b> ${sig}${(r.signal||"").length>120 ? "…" : ""}
            </div>
          </div>
        `;
      }).join("");
    }

    // -------------------------
    // ✅ Client-side share payload helper
    // -------------------------
    function b64UrlEncodeUnicode(str) {
      try {
        const utf8 = encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (_, p1) =>
          String.fromCharCode(parseInt(p1, 16))
        );
        const b64 = btoa(utf8);
        return b64.replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
      } catch {
        return "";
      }
    }

    function buildClientShareUrl(reportPayload) {
      const json = JSON.stringify(reportPayload || {});
      const enc = b64UrlEncodeUnicode(json);
      if (!enc) return "";
      const u = new URL(window.location.origin + "/result.html");
      u.searchParams.set("p", enc);
      return u.toString();
    }

    // -------------------------
    // Auth storage
    // -------------------------
    const AUTH_TOKEN_KEY = "fxco_auth_token_v1";
    const AUTH_EMAIL_KEY = "fxco_auth_email_v1";
    const TRIAL_END_KEY  = "fxco_trial_end_v1";

    function getAuthToken() { try { return localStorage.getItem(AUTH_TOKEN_KEY) || ""; } catch { return ""; } }
    function getAuthEmail() { try { return localStorage.getItem(AUTH_EMAIL_KEY) || ""; } catch { return ""; } }

    function setAuth(email, token, trialEnds) {
      try {
        if (email) localStorage.setItem(AUTH_EMAIL_KEY, email);
        if (token) localStorage.setItem(AUTH_TOKEN_KEY, token);
        if (trialEnds) localStorage.setItem(TRIAL_END_KEY, String(trialEnds));
      } catch {}
    }
    function clearAuth() {
      try {
        localStorage.removeItem(AUTH_TOKEN_KEY);
        localStorage.removeItem(AUTH_EMAIL_KEY);
        localStorage.removeItem(TRIAL_END_KEY);
      } catch {}
    }
    function isTrialActiveLocal() {
      try {
        const end = Number(localStorage.getItem(TRIAL_END_KEY) || "0");
        if (!end) return false;
        return Date.now() < end * 1000;
      } catch { return false; }
    }

    function trialDaysLeft() {
      try {
        const end = Number(localStorage.getItem(TRIAL_END_KEY) || "0");
        if (!end) return null;
        const ms = (end * 1000) - Date.now();
        if (ms <= 0) return 0;
        return Math.max(1, Math.ceil(ms / (24 * 60 * 60 * 1000)));
      } catch { return null; }
    }

    function setAuthStatus(msg, kind) {
      const el = document.getElementById("authStatus");
      if (!el) return;
      if (!msg) { el.style.display = "none"; el.innerText = ""; el.className = "auth-status"; return; }
      el.style.display = "block";
      el.innerText = msg;
      el.className = "auth-status " + (kind || "");
    }

    function openAuth() {
      document.getElementById("authBackdrop").style.display = "block";
      document.getElementById("authModal").style.display = "block";
      const email = getAuthEmail();
      if (email) document.getElementById("authEmail").value = email;
      setAuthStatus("", "");
    }
    function closeAuth() {
      document.getElementById("authBackdrop").style.display = "none";
      document.getElementById("authModal").style.display = "none";
      setAuthStatus("", "");
    }

    function authPasteSavedEmail() {
      const e = getAuthEmail();
      if (e) document.getElementById("authEmail").value = e;
    }

    async function authSendCode() {
      const email = (document.getElementById("authEmail").value || "").trim().toLowerCase();
      if (!email || !email.includes("@")) {
        setAuthStatus("Enter a valid email.", "auth-danger");
        return;
      }
      setAuthStatus("Sending code…", "");
      try {
        const res = await fetch(apiUrl("/api/auth/start"), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email })
        });
        const j = await res.json().catch(() => null);
        if (!res.ok || !j?.ok) {
          setAuthStatus("Failed: " + (j?.error || "Unable to send OTP."), "auth-danger");
          return;
        }
        try { localStorage.setItem(AUTH_EMAIL_KEY, email); } catch {}
        setAuthStatus("Code sent. Check your inbox (and spam).", "auth-ok");
      } catch (e) {
        setAuthStatus("Failed: " + (e?.message || "Network error"), "auth-danger");
      }
    }

    async function authVerifyCode() {
      const email = (document.getElementById("authEmail").value || "").trim().toLowerCase();
      const code = (document.getElementById("authCode").value || "").trim();
      if (!email || !email.includes("@")) {
        setAuthStatus("Enter a valid email.", "auth-danger");
        return;
      }
      if (!/^\d{6}$/.test(code)) {
        setAuthStatus("Enter the 6-digit code.", "auth-danger");
        return;
      }

      setAuthStatus("Verifying…", "");
      try {
        const res = await fetch(apiUrl("/api/auth/verify"), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, code })
        });
        const j = await res.json().catch(() => null);
        if (!res.ok || !j?.ok || !j?.token) {
          setAuthStatus("Failed: " + (j?.error || "Verification failed."), "auth-danger");
          return;
        }
        setAuth(email, j.token, j.trial_ends || 0);
        setAuthStatus("Verified ✅ Trial active.", "auth-ok");
        updateTrialButton();
        applyPaymentGateUI();
        closeAuth();
      } catch (e) {
        setAuthStatus("Failed: " + (e?.message || "Network error"), "auth-danger");
      }
    }

    function authLogout() {
      clearAuth();
      updateTrialButton();
      applyPaymentGateUI();
      setAuthStatus("Signed out.", "auth-ok");
    }

    function updateTrialButton() {
      const btn = document.getElementById("trialBtn");
      if (!btn) return;

      const token = getAuthToken();
      const active = isTrialActiveLocal();
      const days = trialDaysLeft();

      if (token && active) {
        btn.innerText = days ? `Trial Active ✅ (${days}d left)` : "Trial Active ✅";
        btn.className = "topbtn primary";
      } else if (token && !active) {
        btn.innerText = "Trial Ended • Verify";
        btn.className = "topbtn warn";
      } else {
        btn.innerText = "Start Free Trial";
        btn.className = "topbtn warn";
      }
    }

    // -------------------------
    // Payment state
    // -------------------------
    const PAID_KEY = "fxco_paid_v1";
    const PAID_REF_KEY = "fxco_paid_ref_v1";
    let PAYSTACK_CONFIG = { ok:false };

    function setPayHint(msg, show=true) {
      const el = document.getElementById("payHint");
      if (!el) return;
      if (!show || !msg) { el.style.display = "none"; el.innerText = ""; return; }
      el.style.display = "block";
      el.innerText = msg;
    }

    function isPaid() { try { return localStorage.getItem(PAID_KEY) === "1"; } catch { return false; } }
    function getPaidRef() { try { return localStorage.getItem(PAID_REF_KEY) || ""; } catch { return ""; } }
    function setPaid(reference) {
      try {
        localStorage.setItem(PAID_KEY, "1");
        if (reference) localStorage.setItem(PAID_REF_KEY, reference);
      } catch {}
    }

    // -------------------------
    // Rate limit UX
    // -------------------------
    let rateTimer = null;

    function setRateHint(msg, show=true) {
      const el = document.getElementById("rateHint");
      if (!el) return;
      if (!show || !msg) { el.style.display = "none"; el.innerText = ""; return; }
      el.style.display = "block";
      el.innerText = msg;
    }

    function startRateCooldown(seconds) {
      const btn = document.getElementById("analyzeBtn");
      let remaining = Math.max(1, Number(seconds || 1));
      const accepted = document.getElementById("acceptLegal")?.checked;

      btn.disabled = true;
      setRateHint(`Rate limit hit. Try again in ${remaining}s…`, true);

      if (rateTimer) clearInterval(rateTimer);
      rateTimer = setInterval(() => {
        remaining -= 1;
        if (remaining <= 0) {
          clearInterval(rateTimer);
          rateTimer = null;
          setRateHint("", false);
          btn.disabled = !accepted || !navigator.onLine;
          applyPaymentGateUI();
          return;
        }
        setRateHint(`Rate limit hit. Try again in ${remaining}s…`, true);
      }, 1000);
    }

    function showRateRemainingFromHeaders(res) {
      try {
        const plan = res.headers.get("X-RateLimit-Plan") || "";
        const rem60 = res.headers.get("X-RateLimit-Remaining-60s");
        const lim60 = res.headers.get("X-RateLimit-Limit-60s");
        const rem24 = res.headers.get("X-RateLimit-Remaining-24h");
        const lim24 = res.headers.get("X-RateLimit-Limit-24h");

        const hasAny = (rem60 && lim60) || (rem24 && lim24);
        if (!hasAny) return;

        const bits = [];
        if (plan) bits.push(`Plan: ${plan}`);
        if (rem60 && lim60) bits.push(`Requests left (60s): ${rem60}/${lim60}`);
        if (rem24 && lim24) bits.push(`Requests left (24h): ${rem24}/${lim24}`);

        setRateHint(bits.join(" • "), true);

        if (!rateTimer) {
          setTimeout(() => {
            if (!rateTimer) setRateHint("", false);
          }, 6000);
        }
      } catch {}
    }

    // -------------------------
    // Consent gate
    // -------------------------
    function setAnalyzeEnabled(enabled) {
      const btn = document.getElementById("analyzeBtn");
      const hint = document.getElementById("consentHint");
      if (btn) btn.disabled = !enabled || !navigator.onLine;
      if (hint) hint.style.display = enabled ? "none" : "block";
    }

    function initConsentGate() {
      const cb = document.getElementById("acceptLegal");
      if (!cb) return;

      try {
        const saved = localStorage.getItem("fxco_accept_legal_v1");
        if (saved === "1") cb.checked = true;
      } catch {}

      setAnalyzeEnabled(cb.checked);

      cb.addEventListener("change", () => {
        if (rateTimer) setAnalyzeEnabled(false);
        else setAnalyzeEnabled(cb.checked);
        try { localStorage.setItem("fxco_accept_legal_v1", cb.checked ? "1" : "0"); } catch {}
        applyPaymentGateUI();
      });
    }

    // -------------------------
    // Legal modal
    // -------------------------
    function openLegal(which) {
      const backdrop = document.getElementById("legalBackdrop");
      const modal = document.getElementById("legalModal");
      const title = document.getElementById("legalTitle");
      const content = document.getElementById("legalContent");

      const updated = new Date().toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });

      const termsHtml = `
        <div class="legal-callout">
          <p style="margin:0;">
            <strong>Important:</strong> FXCO-PILOT provides AI-assisted market analysis for <strong>educational and informational purposes only</strong>.
            It does <strong>not</strong> provide financial, investment, or trading advice. Trading involves risk and you may lose money.
            <br/><br/>
            <strong>AI Confidence is not a guarantee.</strong>
          </p>
        </div>

        <p><b>Last updated:</b> ${updated}</p>

        <h2>1) Acceptance of Terms</h2>
        <p>By accessing or using FXCO-PILOT (the “Service”), you agree to these Terms. If you do not agree, do not use the Service.</p>

        <h2>2) No Financial Advice</h2>
        <p>The Service is not a broker, dealer, or financial advisor. Outputs may be inaccurate or unsuitable. You are solely responsible for your trading decisions and outcomes.</p>

        <h2>3) AI Outputs & Limitations</h2>
        <p>AI outputs are probabilistic. Any “confidence” score is an estimate, not a guarantee.</p>
      `;

      const privacyHtml = `
        <p><b>Last updated:</b> ${updated}</p>
        <h2>1) What We Collect</h2>
        <ul>
          <li><b>Inputs you provide:</b> signals you paste and optional chart uploads, processed to generate analysis.</li>
        </ul>
      `;

      if (which === "terms") {
        title.textContent = "Terms of Service";
        content.innerHTML = termsHtml;
      } else {
        title.textContent = "Privacy Policy";
        content.innerHTML = privacyHtml;
      }

      backdrop.style.display = "block";
      modal.style.display = "block";
    }

    function closeLegal() {
      document.getElementById("legalBackdrop").style.display = "none";
      document.getElementById("legalModal").style.display = "none";
    }

    // -------------------------
    // Risk modal
    // -------------------------
    function showRiskModalIfNeeded() {
      try {
        const seen = localStorage.getItem("fxco_risk_ack_v1");
        if (seen === "1") return;
        document.getElementById("riskBackdrop").style.display = "block";
        document.getElementById("riskModal").style.display = "block";
        document.body.style.overflow = "hidden";
      } catch {
        document.getElementById("riskBackdrop").style.display = "block";
        document.getElementById("riskModal").style.display = "block";
        document.body.style.overflow = "hidden";
      }
    }

    function acknowledgeRisk() {
      try { localStorage.setItem("fxco_risk_ack_v1", "1"); } catch {}
      document.getElementById("riskBackdrop").style.display = "none";
      document.getElementById("riskModal").style.display = "none";
      document.body.style.overflow = "";
    }

    // -------------------------
    // Pricing modal
    // -------------------------
    function openPricing() {
      document.getElementById("pricingBackdrop").style.display = "block";
      document.getElementById("pricingModal").style.display = "block";
    }
    function closePricing() {
      document.getElementById("pricingBackdrop").style.display = "none";
      document.getElementById("pricingModal").style.display = "none";
    }

    // -------------------------
    // Paystack
    // -------------------------
    function formatMoneyMinor(amountMinor, currency) {
      const amt = Number(amountMinor || 0);
      const cur = (currency || "NGN").toUpperCase();
      const major = amt / 100;
      try {
        return new Intl.NumberFormat(undefined, { style: "currency", currency: cur }).format(major);
      } catch {
        return `${cur} ${major.toFixed(2)}`;
      }
    }

    async function loadPaystackConfig() {
      try {
        const res = await fetch(apiUrl("/api/paystack/config"), { cache: "no-store" });
        const j = await res.json();
        PAYSTACK_CONFIG = j || { ok:false };

        const amountEl = document.getElementById("pricingAmount");
        if (amountEl && j && typeof j.amount !== "undefined") {
          amountEl.innerText = formatMoneyMinor(j.amount, j.currency);
        }
        applyPaymentGateUI();
      } catch {
        applyPaymentGateUI();
      }
    }

    function applyPaymentGateUI() {
      const paid = isPaid();
      const accepted = document.getElementById("acceptLegal")?.checked;
      const requirePayment = !!PAYSTACK_CONFIG?.require_payment;

      const token = getAuthToken();
      const trialActive = token && isTrialActiveLocal();

      const statusEl = document.getElementById("pricingStatus");
      if (statusEl) {
        statusEl.innerText = paid ? "Active Access" : (trialActive ? "Trial Active" : (requirePayment ? "Locked" : "Optional"));
      }

      const btn = document.getElementById("analyzeBtn");
      if (!btn) return;
      if (rateTimer) return;

      if (!navigator.onLine) {
        btn.disabled = true;
        return;
      }

      if (requirePayment && !paid && !trialActive) {
        btn.disabled = true;
        if (accepted) setPayHint("Start your free trial (verify email) or open Pricing to unlock.", true);
        return;
      }

      setPayHint("", false);
      btn.disabled = !accepted;
    }

    async function startPaystackCheckout() {
      const emailSeed = getAuthEmail() || "";
      const email = (prompt("Enter your email for Paystack checkout:", emailSeed) || "").trim();
      if (!email || !email.includes("@")) {
        alert("Please enter a valid email.");
        return;
      }

      try {
        const res = await fetch(apiUrl("/api/paystack/init"), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email })
        });

        const j = await res.json().catch(() => null);
        if (!res.ok || !j?.ok || !j?.authorization_url) {
          alert("Paystack init failed: " + (j?.error || "Unknown error"));
          return;
        }

        try { localStorage.setItem(PAID_REF_KEY, j.reference || ""); } catch {}
        window.location.href = j.authorization_url;
      } catch (e) {
        alert("Checkout failed: " + (e?.message || "Unknown error"));
      }
    }

    function getQueryParam(name) {
      const u = new URL(window.location.href);
      return u.searchParams.get(name);
    }

    async function verifyPaystackIfReturned() {
      const paystack = getQueryParam("paystack");
      const reference = getQueryParam("reference") || getQueryParam("trxref") || getPaidRef();
      if (paystack !== "success" || !reference) return;

      try {
        const statusEl = document.getElementById("pricingStatus");
        if (statusEl) statusEl.innerText = "Verifying payment…";

        const res = await fetch(apiUrl("/api/paystack/verify?reference=" + encodeURIComponent(reference)));
        const j = await res.json().catch(() => null);

        if (res.ok && j?.ok && j?.paid) {
          setPaid(reference);
          alert("Payment verified. Access unlocked ✅");
        } else {
          alert("Payment not verified yet. If you were charged, refresh in a minute.");
        }

        const u = new URL(window.location.href);
        u.searchParams.delete("paystack");
        u.searchParams.delete("reference");
        u.searchParams.delete("trxref");
        window.history.replaceState({}, "", u.toString());
      } finally {
        applyPaymentGateUI();
      }
    }

    // -------------------------
    // Tier helpers (normalize)
    // -------------------------
    function normalizeTier(tier){
      const t = String(tier || "").trim().toUpperCase();
      if (t === "EXECUTE-IF") return "EXECUTE_IF";
      if (t === "DO-NOT-TRADE") return "DO_NOT_TRADE";
      return t;
    }

    // -------------------------
    // ✅ Signal Cleaner (client-side)
    // -------------------------
    function normalizeSignalText(s){
      return String(s || "")
        .replace(/\u00A0/g, " ")
        .replace(/[，]/g, ",")
        .replace(/[–—]/g, "-")
        .replace(/[“”]/g, "\"")
        .replace(/[‘’]/g, "'")
        .trim();
    }

    function detectPair(text){
      const t = text.toUpperCase();

      // Common aliases
      if (/(XAU\/?USD|GOLD)\b/.test(t)) return "XAUUSD";
      if (/(XAG\/?USD|SILVER)\b/.test(t)) return "XAGUSD";
      if (/(BTC\/?USD|BTCUSDT|BITCOIN)\b/.test(t)) return "BTCUSD";
      if (/(ETH\/?USD|ETHUSDT|ETHEREUM)\b/.test(t)) return "ETHUSD";

      // Forex pairs: EURUSD, EUR/USD, GBPJPY etc.
      const m = t.match(/\b([A-Z]{3})\s*\/?\s*([A-Z]{3})\b/);
      if (m) return (m[1] + m[2]).toUpperCase();

      // Fallback: explicit 6-letter (EURUSD)
      const m2 = t.match(/\b([A-Z]{6})\b/);
      if (m2) return m2[1].toUpperCase();

      return "";
    }

    function detectSide(text){
      const t = text.toUpperCase();
      if (/\b(BUY|LONG|BULL|CALL)\b/.test(t)) return "BUY";
      if (/\b(SELL|SHORT|BEAR|PUT)\b/.test(t)) return "SELL";
      return "";
    }

    function detectPrices(text){
      const t = text.toUpperCase();

      // SL
      let sl = "";
      const slm = t.match(/\bSL\b[^0-9]*([0-9]+(?:\.[0-9]+)?)/);
      if (slm) sl = slm[1];

      // TP targets
      let tps = [];
      // TP 2050 / TP1 2050 / TP: 2050,2060
      const tpm = t.match(/\bTP(?:\d+)?\b[^0-9]*([0-9]+(?:\.[0-9]+)?(?:\s*[-,]\s*[0-9]+(?:\.[0-9]+)?)*)/);
      if (tpm) {
        tps = tpm[1].split(/[-,]/).map(x => x.trim()).filter(Boolean);
      }

      // Entry: try explicit keywords first
      let entry = "";
      const em1 = t.match(/\bENTRY\b[^0-9]*([0-9]+(?:\.[0-9]+)?(?:\s*[-,]\s*[0-9]+(?:\.[0-9]+)?)*)/);
      if (em1) entry = em1[1].split(/[-,]/).map(x => x.trim()).filter(Boolean).join(" - ");

      // If no entry keyword, try pattern after BUY/SELL
      if (!entry) {
        const em2 = t.match(/\b(BUY|SELL|LONG|SHORT)\b[^0-9]*([0-9]+(?:\.[0-9]+)?(?:\s*[-,]\s*[0-9]+(?:\.[0-9]+)?)*)/);
        if (em2) entry = em2[2].split(/[-,]/).map(x => x.trim()).filter(Boolean).join(" - ");
      }

      return { entry, sl, tps };
    }

    function buildCleanSignal(pair, side, entry, sl, tps){
      const parts = [];
      if (pair) parts.push(pair);
      if (side) parts.push(side);
      if (entry) parts.push(`ENTRY ${entry}`);
      if (sl) parts.push(`SL ${sl}`);
      if (tps && tps.length) parts.push(`TP ${tps.join(", ")}`);
      return parts.join(" • ").trim();
    }

    function renderSignalCard(){
      const ta = document.getElementById("signal");
      const card = document.getElementById("signalCard");
      const tags = document.getElementById("signalTags");
      const meta = document.getElementById("signalMeta");
      if (!ta || !card || !tags || !meta) return;

      const raw = normalizeSignalText(ta.value || "");
      if (!raw) { card.style.display = "none"; return; }

      const pair = detectPair(raw);
      const side = detectSide(raw);
      const { entry, sl, tps } = detectPrices(raw);

      const missing = [];
      if (!pair) missing.push("pair");
      if (!side) missing.push("direction");
      if (!entry) missing.push("entry");
      if (!sl) missing.push("SL");
      if (!tps || !tps.length) missing.push("TP");

      const clean = buildCleanSignal(pair, side, entry, sl, tps);

      const tagHtml = [];
      tagHtml.push(`<span class="tag ${pair ? "ok":"warn"}">Pair: ${esc(pair || "—")}</span>`);
      tagHtml.push(`<span class="tag ${side ? "ok":"warn"}">Side: ${esc(side || "—")}</span>`);
      tagHtml.push(`<span class="tag ${entry ? "ok":"warn"}">Entry: ${esc(entry || "—")}</span>`);
      tagHtml.push(`<span class="tag ${sl ? "ok":"warn"}">SL: ${esc(sl || "—")}</span>`);
      tagHtml.push(`<span class="tag ${(tps && tps.length) ? "ok":"warn"}">TP: ${esc((tps && tps.length) ? tps.join(", ") : "—")}</span>`);

      if (missing.length === 0) tagHtml.push(`<span class="tag ok">Ticket complete</span>`);
      else tagHtml.push(`<span class="tag warn">Missing: ${esc(missing.join(", "))}</span>`);

      tags.innerHTML = tagHtml.join("");

      meta.innerHTML = `
        <div><b>Clean format:</b> ${esc(clean || raw)}</div>
        <div style="margin-top:6px;opacity:0.9;">If your signal is messy, FXCO-PILOT still works — but complete tickets get better risk checks.</div>
      `;

      window.__fxco_clean_signal = clean || raw;
      window.__fxco_signal_missing = missing;

      card.style.display = "block";
    }

    function copyCleanSignal(){
      const txt = window.__fxco_clean_signal || "";
      if (!txt) return;
      navigator.clipboard?.writeText(txt).then(() => {
        setRateHint("Copied clean signal ✅", true);
        setTimeout(() => { if (!rateTimer) setRateHint("", false); }, 1800);
      }).catch(() => {
        alert("Copy failed. Please copy manually.");
      });
    }

    function focusMissingFromSignal(){
      const missing = window.__fxco_signal_missing || [];
      // We can't auto-fill without guessing — we guide.
      const el = document.getElementById("signal");
      if (el) el.focus();
      if (missing.length) {
        setRateHint("Quick fix: add " + missing.join(", ") + " into your signal (Entry / SL / TP).", true);
        setTimeout(() => { if (!rateTimer) setRateHint("", false); }, 3500);
      }
    }

    // -------------------------
    // Desk verdict helpers (unchanged)
    // -------------------------
    function parseRR(rr){
      if (rr === null || rr === undefined) return null;
      if (typeof rr === "number" && isFinite(rr)) return rr;
      const s = String(rr);
      const m = s.match(/(\d+(\.\d+)?)/);
      if (!m) return null;
      const n = Number(m[1]);
      return isFinite(n) ? n : null;
    }

    function computeDeskVerdict(analysis){
      const a = analysis || {};
      const conf = clamp(a.confidence, 0, 100);

      const strRaw = Number(a.strength ?? 0);
      const clrRaw = Number(a.clarity ?? 0);
      const str = clamp(strRaw <= 10 ? (strRaw * 10) : strRaw, 0, 100);
      const clr = clamp(clrRaw <= 10 ? (clrRaw * 10) : clrRaw, 0, 100);

      const rr = parseRR(a?.signal_check?.rr);
      const hasEntry = a?.signal_check?.entry != null;
      const hasSL = a?.signal_check?.stop_loss != null;
      const hasTP = Array.isArray(a?.signal_check?.targets) && a.signal_check.targets.length > 0;

      const inv = Array.isArray(a.invalidation_warnings) ? a.invalidation_warnings.filter(Boolean) : [];
      const invCount = inv.length;

      const hardBlocks = [];
      if (!hasEntry || !hasSL || !hasTP) hardBlocks.push("Missing ticket fields (Entry/SL/TP).");
      if (rr !== null && rr < 1.5) hardBlocks.push("RR < 1.5 (fails minimum expectancy).");
      if (conf < 55) hardBlocks.push("Confidence < 55 (edge not proven).");
      if (invCount >= 2) hardBlocks.push("Multiple invalidation warnings (fragile setup).");

      const rrScore = (rr === null) ? 0 : clamp(((rr - 1.0) / 3.0) * 100, 0, 100);

      let score =
        (conf * 0.52) +
        (str * 0.16) +
        (clr * 0.22) +
        (rrScore * 0.10);

      if (invCount >= 1) score -= 10;
      if (invCount >= 2) score -= 10;
      if (!hasEntry || !hasSL || !hasTP) score -= 12;

      score = clamp(score, 0, 100);

      let tier = "WAIT";
      if (score >= 78 && hardBlocks.length === 0) tier = "EXECUTE";
      else if (score >= 62) tier = "EXECUTE_IF";
      else if (score >= 48) tier = "WAIT";
      else tier = "DO_NOT_TRADE";

      const reasons = [];
      reasons.push(`Edge ${Math.round(score)}/100`);
      reasons.push(`Conf ${Math.round(conf)}%`);
      if (rr !== null) reasons.push(`RR ${rr.toFixed(2)}`);
      reasons.push(`Strength ${Math.round(str)}/100`);
      reasons.push(`Clarity ${Math.round(clr)}/100`);
      if (invCount) reasons.push(`${invCount} flag${invCount>1?"s":""}`);

      let why = "";
      let action = "";

      if (tier === "EXECUTE") {
        why = "Edge is confirmed. Ticket is complete and flags are acceptable.";
        action = "Execute with strict size, hard SL, and no revenge entries.";
      } else if (tier === "EXECUTE_IF") {
        why = "Edge exists but needs confirmation. Conditions must be met before entry.";
        action = "Reduce size + require confirmation (break/close, sweep, or retest).";
      } else if (tier === "WAIT") {
        why = "No clear edge yet. Context is not aligned or information is incomplete.";
        action = "Wait. Set alerts at key levels and reassess.";
      } else {
        why = "Fails desk rules (expectancy / completeness / risk flags).";
        action = "Stand down. Only re-enter if the setup materially improves.";
      }

      return {
        tier,
        score: Math.round(score),
        conf: Math.round(conf),
        str: Math.round(str),
        clr: Math.round(clr),
        rr,
        invCount,
        why,
        action,
        reasons,
        hardBlocks
      };
    }

    // -------------------------
    // Preview modal
    // -------------------------
    function openPreview() {
      document.getElementById("previewBackdrop").style.display = "block";
      document.getElementById("previewModal").style.display = "block";
      document.body.style.overflow = "hidden";
    }
    function closePreview() {
      document.getElementById("previewBackdrop").style.display = "none";
      document.getElementById("previewModal").style.display = "none";
      document.body.style.overflow = "";
    }
    function openFullReport(){
      closePreview();
      window.location.href = "/result.html";
    }

    // -------------------------
    // ✅ Field guard helpers (UX)
    // -------------------------
   function clearFieldWarn(){
    ["pairType","timeframe","chartTf","htfBias","signal"].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.classList.remove("field-warn");
   });
  }

    function warnField(id){
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.add("field-warn");
      try { el.scrollIntoView({ behavior:"smooth", block:"center" }); } catch {}
      el.focus?.();
      setTimeout(() => el.classList.remove("field-warn"), 2200);
    }

    // -------------------------
    // Analyze (keeps your backend behavior intact)
    // -------------------------
    async function analyze() {
      const htfBias = (document.getElementById("htfBias")?.value || "").trim();
      const accepted = document.getElementById("acceptLegal")?.checked;
      if (!accepted) { setAnalyzeEnabled(false); return; }
      if (rateTimer) return;

      clearFieldWarn();

      if (!navigator.onLine) {
        document.getElementById("result").innerHTML =
          "<b style='color:#ffd86b'>Offline:</b> Reconnect to run analysis.";
        return;
      }

      const trialActive = getAuthToken() && isTrialActiveLocal();
      if (PAYSTACK_CONFIG?.require_payment && !isPaid() && !trialActive) {
        openAuth();
        return;
      }

      setRateHint("", false);

      const pairType = (document.getElementById("pairType")?.value || "").trim();
      const timeframe = (document.getElementById("timeframe")?.value || "").trim();
      const chartTf = (document.getElementById("chartTf")?.value || "").trim();
      const signalEl = document.getElementById("signal");
      const signal = (signalEl?.value || "").trim();

      if (!pairType) { warnField("pairType"); return; }
      if (!timeframe) { warnField("timeframe"); return; }
      if (!chartTf) {
        warnField("chartTf");
        document.getElementById("result").innerHTML =
          "<b style='color:#ff6b6b'>Missing:</b> Select your <b>Chart Timeframe</b> (what you’re on).";
        return;
      }
      if (!htfBias) {
        warnField("htfBias");
      document.getElementById("result").innerHTML =
     "<b style='color:#ff6b6b'>Missing:</b> Select your <b>Higher Timeframe Bias</b> (Bullish/Bearish/Range/Unclear).";
    return;
      }

      if (!signal) { warnField("signal"); return; }

      const file = document.getElementById("chart")?.files?.[0] || null;

      const btn = document.getElementById("analyzeBtn");
      btn.disabled = true;
      btn.innerText = "Validating…";
      document.getElementById("result").innerHTML = "Analyzing…";

      try {
        const headers = { "X-FXCO-Client": FXCO_CLIENT_ID };

        const token = getAuthToken();
        if (token) headers["X-FXCO-Auth"] = token;

        const ref = getPaidRef();
        if (ref) headers["X-FXCO-Paystack-Ref"] = ref;

        let res;
        if (file) {
          const formData = new FormData();
          formData.append("pair_type", pairType);
          formData.append("timeframe", timeframe);
          formData.append("chart_tf", chartTf);
          formData.append("signal_input", signal);
          formData.append("chart_image", file);

          res = await fetch(apiUrl("/api/analyze"), { method: "POST", body: formData, headers });
        } else {
          headers["Content-Type"] = "application/json";
          res = await fetch(apiUrl("/api/analyze"), {
            method: "POST",
            headers,
            body: JSON.stringify({
              pair_type: pairType,
              timeframe,
              chart_tf: chartTf,
              signal_input: signal
            })
          });
        }

        const ct = res.headers.get("content-type") || "";
        showRateRemainingFromHeaders(res);

        const trialEndsHdr = res.headers.get("X-FXCO-Trial-Ends");
        if (trialEndsHdr) {
          const n = Number(trialEndsHdr);
          if (n) { try { localStorage.setItem(TRIAL_END_KEY, String(n)); } catch {} }
          updateTrialButton();
        }

        if (res.status === 429) {
          let retryAfter = Number(res.headers.get("Retry-After") || 0);
          let j = null;
          if (ct.includes("application/json")) { try { j = await res.json(); } catch {} }
          else { const t = await res.text().catch(() => ""); j = { error: t || "Too many requests" }; }
          const seconds = Number((j && j.retry_after_seconds) || retryAfter || 10);
          document.getElementById("result").innerHTML =
            "<b style='color:#ffd86b'>Rate limit:</b> Too many requests. Please slow down.";
          startRateCooldown(seconds);
          btn.innerText = "Validate Trade";
          btn.disabled = false;
          applyPaymentGateUI();
          return;
        }

        if (res.status === 402) {
          let j = null;
          if (ct.includes("application/json")) { try { j = await res.json(); } catch {} }
          else { const t = await res.text().catch(() => ""); j = { error: t || "Access locked" }; }
          document.getElementById("result").innerHTML =
            "<b style='color:#ffd86b'>Access locked:</b> " + esc(j?.error || "Payment required.") +
            "<br/><span style='opacity:0.9'>Start Trial (verify email) or open Pricing to unlock.</span>";
          btn.innerText = "Validate Trade";
          btn.disabled = false;
          applyPaymentGateUI();
          openAuth();
          return;
        }

        if (res.status === 400) {
          let j = null;
          if (ct.includes("application/json")) { try { j = await res.json(); } catch {} }
          else { const t = await res.text().catch(() => ""); j = { error: t || "Bad request" }; }
          const missing = Array.isArray(j?.missing) ? j.missing.join(", ") : "";
          document.getElementById("result").innerHTML =
            "<b style='color:#ff6b6b'>Request failed (400):</b> " + esc(j?.error || "Bad request") +
            (missing ? `<br/><span style="opacity:0.9">Missing: ${esc(missing)}</span>` : "");
          btn.innerText = "Validate Trade";
          btn.disabled = false;
          applyPaymentGateUI();
          return;
        }

        if (!res.ok) {
          if (ct.includes("application/json")) {
            const j = await res.json().catch(() => null);
            throw new Error(j?.error || "Request failed.");
          }
          const t = await res.text().catch(() => "");
          throw new Error(t || "Request failed.");
        }

        if (!ct.includes("application/json")) {
          const t = await res.text().catch(() => "");
          throw new Error("Server did not return JSON. Got: " + t.slice(0, 120));
        }

        const data = await res.json();

        const reportPayload = {
          pair_type: pairType,
          timeframe,
          chart_tf: chartTf,
          signal_input: signal,
          analysis: data?.analysis || null,
          raw: data || null,
          generated_at: Date.now(),
          share_id: data?.share_id || data?.analysis?.share_id || "",
          share_url: data?.share_url || data?.analysis?.share_url || ""
        };

        const clientShareUrl = buildClientShareUrl(reportPayload);
        if (clientShareUrl) reportPayload.share_url = reportPayload.share_url || clientShareUrl;

        try { sessionStorage.setItem(REPORT_KEY, JSON.stringify(reportPayload)); } catch {}
        try { localStorage.setItem("fxcoReport_last_v1", JSON.stringify(reportPayload)); } catch {}

        addToLocalReportsList(reportPayload);
        renderLocalHistory();
        updateViewReportButton();

        const backendTier = normalizeTier(reportPayload?.analysis?.decision_tier || "");
        const backendScore = Number(reportPayload?.analysis?.score);
        const backendConf = Number(reportPayload?.analysis?.confidence);

        let v = computeDeskVerdict(reportPayload.analysis || {});
        if (backendTier) {
          v.tier = backendTier;
          if (isFinite(backendScore)) v.score = Math.round(backendScore);
          if (isFinite(backendConf)) v.conf = Math.round(backendConf);
        }

        const ticket = reportPayload.analysis?.signal_check || {};
        const entry = ticket.entry ?? "—";
        const sl = ticket.stop_loss ?? "—";
        const tp1 = (Array.isArray(ticket.targets) && ticket.targets[0] != null) ? ticket.targets[0] : "—";

        const tierColor =
          v.tier === "EXECUTE" ? "#00d46a" :
          v.tier === "EXECUTE_IF" ? "#fbbf24" :
          v.tier === "WAIT" ? "#94a3b8" :
          "#ff5a5f";

        const blocksHtml = (v.hardBlocks || []).map(x => `<div style="margin-top:4px;">• ${esc(x)}</div>`).join("");

        document.getElementById("result").innerHTML = `
          <div style="border:1px solid rgba(255,255,255,0.10);background:rgba(255,255,255,0.04);border-radius:16px;padding:16px;">
            <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start;flex-wrap:wrap;">
              <div style="font-weight:1000;color:${tierColor};letter-spacing:0.3px;font-size:14px;line-height:1.2;">
                ${esc(v.tier)} • EDGE ${esc(v.score)}/100
              </div>
              <div style="opacity:0.9;font-size:12px;line-height:1.5;">
                Conf ${esc(v.conf)}% ${v.rr !== null ? `• RR ${esc(v.rr.toFixed(2))}` : ""} • Flags ${esc(v.invCount)}
              </div>
            </div>

            <div style="margin-top:10px;opacity:0.92;font-size:12px;line-height:1.5;">
              <b>Style:</b> ${esc(timeframe)} • <b>Chart TF:</b> ${esc(chartTf)}
            </div>

            <div style="margin-top:10px;display:grid;grid-template-columns:repeat(3,1fr);gap:10px;">
              <div style="border:1px solid rgba(255,255,255,0.10);border-radius:14px;padding:10px;background:rgba(0,0,0,0.18);">
                <div style="font-size:11px;opacity:0.85;line-height:1.2;">ENTRY</div>
                <div style="font-weight:900;color:#fff;margin-top:2px;line-height:1.2;">${esc(entry)}</div>
              </div>
              <div style="border:1px solid rgba(255,255,255,0.10);border-radius:14px;padding:10px;background:rgba(0,0,0,0.18);">
                <div style="font-size:11px;opacity:0.85;line-height:1.2;">STOP LOSS</div>
                <div style="font-weight:900;color:#fff;margin-top:2px;line-height:1.2;">${esc(sl)}</div>
              </div>
              <div style="border:1px solid rgba(255,255,255,0.10);border-radius:14px;padding:10px;background:rgba(0,0,0,0.18);">
                <div style="font-size:11px;opacity:0.85;line-height:1.2;">TP1</div>
                <div style="font-weight:900;color:#fff;margin-top:2px;line-height:1.2;">${esc(tp1)}</div>
              </div>
            </div>

            <div style="margin-top:10px;color:#e5e7eb;font-size:12px;line-height:1.6;">
              ${esc(v.why)}<br/>
              <span style="opacity:0.9;">${esc(v.action)}</span>
            </div>

            ${v.hardBlocks && v.hardBlocks.length ? `
              <div style="margin-top:10px;border:1px solid rgba(255,90,95,0.22);background:rgba(255,90,95,0.08);padding:12px;border-radius:14px;">
                <div style="font-weight:1000;color:#ff9aa2;margin-bottom:4px;line-height:1.2;">Hard Blocks</div>
                <div style="font-size:12px;line-height:1.6;color:#ffd1d6;">${blocksHtml}</div>
              </div>
            ` : ""}

            <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;">
              <button class="topbtn" onclick="openPreview()">View Preview</button>
              <button class="topbtn primary" onclick="openFullReport()">Open Full Report</button>
            </div>

            ${clientShareUrl ? `
              <div style="margin-top:10px;opacity:0.85;font-size:12px;line-height:1.5;">
                <b>Share link ready:</b> <span style="opacity:0.95;">Use the report page → “Copy Share Link”.</span>
              </div>
            ` : ""}
          </div>
        `;

        document.getElementById("previewMeta").textContent = `${pairType} • ${timeframe} • TF ${chartTf} • ${v.tier}`;

        const banner = document.getElementById("previewBanner");
        banner.classList.remove("dec-ok","dec-cond","dec-wait","dec-bad");

        if (v.tier === "EXECUTE"){
          banner.classList.add("dec-ok");
          document.getElementById("previewIcon").textContent = "✓";
          document.getElementById("previewTier").textContent = "EXECUTE (DESK-OK)";
        } else if (v.tier === "EXECUTE_IF"){
          banner.classList.add("dec-cond");
          document.getElementById("previewIcon").textContent = "!";
          document.getElementById("previewTier").textContent = "EXECUTE_IF (CONDITIONS)";
        } else if (v.tier === "WAIT"){
          banner.classList.add("dec-wait");
          document.getElementById("previewIcon").textContent = "⏸";
          document.getElementById("previewTier").textContent = "WAIT (NO EDGE YET)";
        } else {
          banner.classList.add("dec-bad");
          document.getElementById("previewIcon").textContent = "×";
          document.getElementById("previewTier").textContent = "DO_NOT_TRADE (BLOCKED)";
        }

        document.getElementById("previewWhy").textContent = `${v.why} ${v.action}`;
        document.getElementById("previewScore").textContent = `${v.score}/100`;
        document.getElementById("previewBasis").textContent = v.reasons.join(" • ");
        document.getElementById("previewConf").textContent = `${v.conf}%`;
        document.getElementById("previewSC").textContent = `Strength: ${v.str}/100 • Clarity: ${v.clr}/100`;
        document.getElementById("previewRR").textContent = v.rr !== null ? `RR ${v.rr.toFixed(2)}` : "RR —";
        document.getElementById("previewRiskFlags").textContent = v.invCount ? `${v.invCount} invalidation warning(s)` : "No invalidation warnings";

        const blocksWrap = document.getElementById("previewBlocks");
        const blocksList = document.getElementById("previewBlocksList");
        if (v.hardBlocks && v.hardBlocks.length) {
          blocksWrap.style.display = "block";
          blocksList.innerHTML = v.hardBlocks.map(x => `• ${esc(x)}`).join("<br/>");
        } else {
          blocksWrap.style.display = "none";
          blocksList.innerHTML = "";
        }

        openPreview();

      } catch (err) {
        document.getElementById("result").innerHTML =
          "<b style='color:#ff6b6b'>Request failed:</b> " + esc(err?.message || "Unknown error");
        applyPaymentGateUI();
      } finally {
        const btn = document.getElementById("analyzeBtn");
        if (btn) btn.innerText = "Validate Trade";
        if (!rateTimer) applyPaymentGateUI();
      }
    }

    // -------------------------
    // DOM init
    // -------------------------
    function initAll() {
      registerServiceWorker();

      if (isIos() && isSafari() && !isInStandalone()) {
        showInstallButton(true);
      }

      updateClock();
      setInterval(updateClock, 1000);

      setOfflineUI();

      document.getElementById("authBackdrop")?.addEventListener("click", closeAuth);
      document.getElementById("legalBackdrop")?.addEventListener("click", closeLegal);
      document.getElementById("pricingBackdrop")?.addEventListener("click", closePricing);
      document.getElementById("previewBackdrop")?.addEventListener("click", closePreview);
      document.getElementById("riskBackdrop")?.addEventListener("click", (e) => { e.preventDefault(); e.stopPropagation(); });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") { closeLegal(); closePricing(); closeAuth(); closePreview(); }
        if ((e.ctrlKey || e.metaKey) && e.key === "Enter") { analyze(); }
      });

      initConsentGate();
      showRiskModalIfNeeded();
      loadPaystackConfig();
      verifyPaystackIfReturned();
      updateTrialButton();
      renderLocalHistory();
      updateViewReportButton();

      // ✅ Signal cleaner wiring
      const sig = document.getElementById("signal");
      if (sig) {
        sig.addEventListener("input", () => renderSignalCard());
        sig.addEventListener("blur", () => renderSignalCard());
      }
      renderSignalCard();

      applyPaymentGateUI();
    }

    // -------------------------
    // Make inline onclick handlers reliable
    // -------------------------
    window.analyze = analyze;
    window.openPricing = openPricing;
    window.closePricing = closePricing;
    window.openAuth = openAuth;
    window.closeAuth = closeAuth;
    window.authSendCode = authSendCode;
    window.authVerifyCode = authVerifyCode;
    window.authLogout = authLogout;
    window.authPasteSavedEmail = authPasteSavedEmail;
    window.openLegal = openLegal;
    window.closeLegal = closeLegal;
    window.openFullReport = openFullReport;
    window.openPreview = openPreview;
    window.closePreview = closePreview;
    window.goToLastReport = goToLastReport;
    window.startPaystackCheckout = startPaystackCheckout;
    window.acknowledgeRisk = acknowledgeRisk;
    window.installApp = installApp;

    // ✅ new global helpers
    window.copyCleanSignal = copyCleanSignal;
    window.focusMissingFromSignal = focusMissingFromSignal;

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initAll);
    } else {
      initAll();
    }
  </script>
</body>
</html>
