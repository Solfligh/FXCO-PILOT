<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FXCO-Pilot — Trade Validation Report</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#f7f9ff;
      --bg2:#ffffff;
      --ink:#0b1220;
      --muted:#5c667a;

      --card:#ffffff;
      --line:rgba(15, 23, 42, .10);
      --shadow: 0 18px 60px rgba(15, 23, 42, .08);
      --shadow2: 0 10px 30px rgba(15, 23, 42, .08);

      --radius: 18px;
      --radius2: 14px;

      /* Verdict colors */
      --okBg: rgba(34,197,94,.14);
      --okLine: rgba(34,197,94,.30);
      --okInk: #166534;

      --condBg: rgba(245,158,11,.14);
      --condLine: rgba(245,158,11,.32);
      --condInk: #92400e;

      --waitBg: rgba(100,116,139,.14);
      --waitLine: rgba(100,116,139,.28);
      --waitInk: #334155;

      --badBg: rgba(239,68,68,.12);
      --badLine: rgba(239,68,68,.30);
      --badInk: #991b1b;

      --btn:#0b1220;
      --btnInk:#ffffff;
      --btn2:#ffffff;
      --btn2Ink:#0b1220;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body{
      margin:0;
      font-family: Poppins, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--ink);
      background:
        radial-gradient(1200px 500px at 15% 10%, rgba(14,165,233,.10), transparent 60%),
        radial-gradient(900px 450px at 85% 0%, rgba(34,197,94,.10), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
    }

    a { color: inherit; text-decoration: none; }

    .wrap{
      max-width: 1120px;
      margin: 0 auto;
      padding: 28px 18px 60px;
    }

    /* Top bar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 10px 4px 18px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
    }

    .mark{
      width: 38px; height: 38px;
      border-radius: 12px;
      background:
        radial-gradient(12px 12px at 30% 30%, rgba(255,255,255,.8), transparent 55%),
        linear-gradient(135deg, rgba(14,165,233,.95), rgba(34,197,94,.90));
      box-shadow: 0 10px 30px rgba(14,165,233,.18);
      border: 1px solid rgba(255,255,255,.6);
    }

    .brand h1{
      font-size: 14px;
      margin:0;
      letter-spacing: .2px;
      font-weight: 600;
      line-height: 1.1;
    }
    .brand p{
      margin:2px 0 0;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.1;
    }

    .actions{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .btn{
      border: 1px solid var(--line);
      background: var(--btn2);
      color: var(--btn2Ink);
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 10px 22px rgba(15,23,42,.06);
      cursor: pointer;
      transition: transform .12s ease, box-shadow .12s ease;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      user-select: none;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 14px 28px rgba(15,23,42,.09); }
    .btn.primary{
      background: var(--btn);
      color: var(--btnInk);
      border-color: rgba(255,255,255,.08);
      box-shadow: 0 16px 40px rgba(11,18,32,.20);
    }

    /* Hero */
    .hero{
      margin-top: 10px;
      border-radius: var(--radius);
      background: rgba(255,255,255,.80);
      border: 1px solid rgba(255,255,255,.55);
      box-shadow: var(--shadow);
      padding: 18px;
      backdrop-filter: blur(10px);
    }

    .heroGrid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
      align-items: start;
    }
    @media (max-width: 900px){
      .heroGrid{ grid-template-columns: 1fr; }
    }

    .titleRow{
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .hero h2{
      margin:0;
      font-size: 18px;
      letter-spacing: .2px;
      font-weight: 600;
    }

    .sub{
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.6;
    }

    /* Institutional decision banner */
    .decisionBanner{
      margin-top: 12px;
      border-radius: 16px;
      padding: 14px 14px;
      border: 1px solid var(--line);
      display:flex;
      align-items:flex-start;
      gap: 12px;
      box-shadow: var(--shadow2);
      background: rgba(255,255,255,.75);
    }
    .bannerIcon{
      width: 36px;
      height: 36px;
      border-radius: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      border: 1px solid rgba(255,255,255,.65);
      box-shadow: 0 10px 22px rgba(15,23,42,.08);
      flex: 0 0 auto;
    }
    .bannerTitle{
      margin:0;
      font-size: 13px;
      font-weight: 800;
      letter-spacing: .2px;
    }
    .bannerSub{
      margin:4px 0 0;
      color: rgba(2,6,23,.75);
      font-size: 12px;
      line-height: 1.55;
    }

    .b-ok{ background: var(--okBg); border-color: var(--okLine); }
    .b-ok .bannerIcon{ background: rgba(34,197,94,.22); color: var(--okInk); }
    .b-ok .bannerTitle{ color: var(--okInk); }

    .b-cond{ background: var(--condBg); border-color: var(--condLine); }
    .b-cond .bannerIcon{ background: rgba(245,158,11,.22); color: var(--condInk); }
    .b-cond .bannerTitle{ color: var(--condInk); }

    .b-wait{ background: var(--waitBg); border-color: var(--waitLine); }
    .b-wait .bannerIcon{ background: rgba(100,116,139,.22); color: var(--waitInk); }
    .b-wait .bannerTitle{ color: var(--waitInk); }

    .b-bad{ background: var(--badBg); border-color: var(--badLine); }
    .b-bad .bannerIcon{ background: rgba(239,68,68,.18); color: var(--badInk); }
    .b-bad .bannerTitle{ color: var(--badInk); }

    /* KPI cards */
    .kpis{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 12px;
    }
    @media (max-width: 700px){
      .kpis{ grid-template-columns: 1fr; }
    }

    .kpi{
      border-radius: var(--radius2);
      border: 1px solid var(--line);
      background: rgba(255,255,255,.65);
      padding: 12px;
      box-shadow: var(--shadow2);
    }
    .kpi .label{
      color: var(--muted);
      font-size: 11px;
      margin:0 0 6px;
      font-weight: 500;
    }
    .kpi .value{
      margin:0;
      font-size: 14px;
      font-weight: 700;
      letter-spacing: .2px;
    }
    .kpi .mini{
      margin-top: 6px;
      font-size: 11px;
      color: var(--muted);
      line-height: 1.5;
    }

    /* Layout below */
    .grid{
      display:grid;
      grid-template-columns: .95fr 1.05fr;
      gap: 14px;
      margin-top: 14px;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border-radius: var(--radius);
      background: rgba(255,255,255,.86);
      border: 1px solid rgba(255,255,255,.55);
      box-shadow: var(--shadow2);
      padding: 16px;
      backdrop-filter: blur(10px);
    }

    .card h3{
      margin:0 0 10px;
      font-size: 14px;
      font-weight: 700;
      letter-spacing: .2px;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .row{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.65);
      border-radius: 14px;
      padding: 12px;
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 10px;
    }

    .row .left{ min-width: 0; }
    .row .key{
      font-size: 11px;
      color: var(--muted);
      margin:0 0 4px;
      font-weight: 600;
      letter-spacing: .2px;
      text-transform: uppercase;
    }
    .row .val{
      margin:0;
      font-size: 13px;
      font-weight: 600;
      word-wrap: break-word;
    }

    .chip{
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 11px;
      font-weight: 800;
      border: 1px solid var(--line);
      white-space: nowrap;
      background: rgba(241,245,249,.9);
      color: #0b1220;
    }
    .chip.good{ background: rgba(34,197,94,.12); border-color: rgba(34,197,94,.22); color: var(--okInk); }
    .chip.warn{ background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.26); color: var(--condInk); }
    .chip.bad{ background: rgba(239,68,68,.10); border-color: rgba(239,68,68,.22); color: var(--badInk); }

    .analysis{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.65);
      border-radius: 14px;
      padding: 14px;
      line-height: 1.75;
      color: #0b1220;
      font-size: 13px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .muted{ color: var(--muted); font-size: 12px; line-height: 1.65; }

    .foot{
      margin-top: 12px;
      color: var(--muted);
      font-size: 11px;
      line-height: 1.6;
      text-align: center;
      padding: 10px 6px 0;
    }

    @media print{
      .topbar .actions{ display:none; }
      body{ background: #fff; }
      .hero, .card{ box-shadow: none; border: 1px solid #ddd; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- Topbar -->
    <div class="topbar">
      <div class="brand">
        <div class="mark"></div>
        <div>
          <h1>FXCO-Pilot</h1>
          <p>AI Trade Validator • Report</p>
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="btnBack">← Back</button>
        <button class="btn" id="btnCopy">Copy Summary</button>
        <button class="btn" id="btnPrint">Print</button>
        <button class="btn primary" id="btnNew">New Validation</button>
      </div>
    </div>

    <!-- Hero -->
    <section class="hero">
      <div class="heroGrid">
        <div>
          <div class="titleRow">
            <div>
              <h2>Trade Validation Report</h2>
              <p class="sub" id="metaLine">Generated —</p>
            </div>
          </div>

          <!-- Institutional decision banner -->
          <div id="decisionBanner" class="decisionBanner b-wait">
            <div class="bannerIcon" id="bannerIcon">⏸</div>
            <div>
              <p class="bannerTitle" id="bannerTitle">WAIT (INSUFFICIENT EDGE)</p>
              <p class="bannerSub" id="bannerSub">Loading institutional verdict…</p>
            </div>
          </div>

          <div class="kpis">
            <div class="kpi">
              <p class="label">Instrument</p>
              <p class="value" id="kpiPair">—</p>
              <div class="mini" id="kpiTf">Timeframe: —</div>
            </div>
            <div class="kpi">
              <p class="label">Direction</p>
              <p class="value" id="kpiSide">—</p>
              <div class="mini" id="kpiBias">Bias: —</div>
            </div>
            <div class="kpi">
              <p class="label">Edge Score</p>
              <p class="value" id="kpiScore">—</p>
              <div class="mini" id="kpiParts">Confidence: — • RR: —</div>
            </div>
          </div>

          <p class="muted" style="margin: 12px 2px 0;">
            Desk rule: we do not “approve” trades on borderline confidence. This report is decision support — not a signal.
          </p>
        </div>

        <div>
          <div class="card" style="padding: 14px;">
            <h3 style="margin-bottom: 10px;">Snapshot</h3>
            <div class="list" id="snapshotList"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Details -->
    <div class="grid">
      <section class="card">
        <h3>Key Checks</h3>
        <div class="list" id="checksList"></div>
        <p class="muted" style="margin: 12px 2px 0;">
          Tip: If any invalidation appears, treat it as a desk-level risk flag unless your chart disproves it.
        </p>
      </section>

      <section class="card">
        <h3>AI Reasoning</h3>
        <div class="analysis" id="analysisBox">Loading…</div>
      </section>
    </div>

    <div class="foot">
      FXCO-Pilot helps you validate decisions before execution. Always confirm on your chart and follow your plan.
    </div>
  </div>

  <script>
    function fmt(v){
      if (v === null || v === undefined || v === "") return "—";
      return String(v);
    }

    function esc(s){
      return String(s ?? "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
      }[m]));
    }

    function safeUpper(v){
      const x = fmt(v);
      if (x === "—") return "—";
      return x.toUpperCase();
    }

    function nowStamp(ts){
      const d = ts ? new Date(ts) : new Date();
      return d.toLocaleString(undefined, { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }

    function chipClass(level){
      const v = (level || "").toLowerCase();
      if (v.includes("good") || v.includes("low") || v.includes("pass") || v.includes("ok") || v.includes("aligned")) return "chip good";
      if (v.includes("warn") || v.includes("medium") || v.includes("caution") || v.includes("moderate")) return "chip warn";
      if (v.includes("bad") || v.includes("high") || v.includes("fail") || v.includes("risk") || v.includes("invalidation")) return "chip bad";
      return "chip";
    }

    function addRow(container, key, val, chip){
      const el = document.createElement("div");
      el.className = "row";
      el.innerHTML = `
        <div class="left">
          <p class="key">${esc(key)}</p>
          <p class="val">${esc(val)}</p>
        </div>
        ${chip ? `<span class="${chipClass(chip)}">${esc(chip)}</span>` : ""}
      `;
      container.appendChild(el);
    }

    function parseRR(rr){
      // rr could be number, "2.64", "RR ≈ 2.6", etc.
      if (rr === null || rr === undefined) return null;
      if (typeof rr === "number" && isFinite(rr)) return rr;
      const s = String(rr);
      const m = s.match(/(\d+(\.\d+)?)/);
      if (!m) return null;
      const n = Number(m[1]);
      return isFinite(n) ? n : null;
    }

    // Normalize payload from index.html
    function normalize(raw){
      // index.html stores:
      // { pair_type, timeframe, signal_input, analysis: { decision, confidence, strength, clarity, signal_check, market_context, invalidation_warnings, why_this_trade, guidance, verdict } , generated_at }
      const r = raw || {};
      const a = r.analysis || {};

      const pair = r.pair_type || r.pairType || a.pair || a.symbol || a.instrument || "";
      const timeframe = r.timeframe || a.timeframe || "";
      const signal = r.signal_input || r.signal || "";

      const confidence = (typeof a.confidence === "number") ? a.confidence : Number(a.confidence || 0);
      const strength = (typeof a.strength === "number") ? a.strength : Number(a.strength || 0);
      const clarity = (typeof a.clarity === "number") ? a.clarity : Number(a.clarity || 0);

      const sc = a.signal_check || {};
      const mc = a.market_context || {};

      const direction = sc.direction || a.direction || a.side || a.bias || "";
      const entry = sc.entry || "";
      const stop = sc.stop_loss || sc.sl || "";
      const targets = Array.isArray(sc.targets) ? sc.targets.join(", ") : (sc.targets || "");
      const rr = parseRR(sc.rr);

      const invalidations = Array.isArray(a.invalidation_warnings) ? a.invalidation_warnings.filter(Boolean) : [];
      const why = Array.isArray(a.why_this_trade) ? a.why_this_trade.filter(Boolean) : [];
      const guidance = Array.isArray(a.guidance) ? a.guidance.filter(Boolean) : [];

      const verdictText = a.verdict || a.decision || ""; // keep raw, but we won’t trust it for the institutional verdict

      const generatedAt = r.generated_at ? new Date(r.generated_at).getTime() : Date.now();

      return {
        pair, timeframe, signal,
        confidence: isFinite(confidence) ? confidence : 0,
        strength: isFinite(strength) ? strength : 0,
        clarity: isFinite(clarity) ? clarity : 0,
        direction,
        entry, stop, targets, rr,
        mc,
        invalidations,
        why,
        guidance,
        verdictText,
        raw: r,
        generatedAt
      };
    }

    // Institutional-level decision rules
    function institutionalVerdict(n){
      // Score components (0..100)
      const conf = clamp(n.confidence, 0, 100);

      // strength/clarity expected 0..10
      const str = clamp(n.strength, 0, 10);
      const clr = clamp(n.clarity, 0, 10);

      // RR usually ~1..4+. Map 1.0 -> 0, 2.0 -> 50, 3.0 -> 80, 4.0 -> 100
      const rr = (n.rr === null || n.rr === undefined) ? null : Math.max(0, Number(n.rr));
      const rrScore = rr === null ? 0 : clamp(((rr - 1.0) / 3.0) * 100, 0, 100);

      // Weighted score (conservative desk-style)
      let score =
        (conf * 0.50) +
        ((str / 10) * 100 * 0.20) +
        ((clr / 10) * 100 * 0.20) +
        (rrScore * 0.10);

      // Penalties
      const invCount = Array.isArray(n.invalidations) ? n.invalidations.length : 0;
      if (invCount >= 1) score -= 14;
      if (invCount >= 2) score -= 10;

      // Hard guards (institutional)
      // 1) If confidence < 55 => cannot be approved
      // 2) If RR exists and < 1.5 => cannot be approved
      // 3) If invalidations exist => cannot be approved (max CONDITIONAL)
      const hardNoApprove =
        (conf < 55) ||
        (rr !== null && rr < 1.5) ||
        (invCount >= 1);

      score = clamp(score, 0, 100);

      // Tiering (desk-like)
      // APPROVED: strong edge + clean
      // CONDITIONAL: edge exists but needs conditions (size down / wait trigger / confirm)
      // WAIT: insufficient edge / mixed context
      // REJECTED: low edge or major invalidation risk
      let tier = "WAIT";
      if (score >= 78 && !hardNoApprove) tier = "APPROVED";
      else if (score >= 62) tier = "CONDITIONAL";
      else if (score >= 48) tier = "WAIT";
      else tier = "REJECTED";

      // Build message
      const reasons = [];
      reasons.push(`Confidence ${Math.round(conf)}%`);
      if (n.rr !== null) reasons.push(`RR ${Number(n.rr).toFixed(2)}`);
      if (isFinite(n.strength)) reasons.push(`Strength ${Math.round(str)}/10`);
      if (isFinite(n.clarity)) reasons.push(`Clarity ${Math.round(clr)}/10`);
      if (invCount) reasons.push(`${invCount} invalidation warning${invCount>1?"s":""}`);

      const why =
        tier === "APPROVED"
          ? "Conditions look aligned. Execute only if your chart matches this setup and risk is defined."
          : tier === "CONDITIONAL"
          ? "Edge exists but it’s not clean enough for automatic approval. Tighten risk, wait for trigger, or reduce size."
          : tier === "WAIT"
          ? "Insufficient edge for a professional entry. Wait for clearer structure or better pricing."
          : "Low edge or elevated invalidation risk. Stand down unless your chart clearly disproves the risks.";

      // Desk-style action guidance (1-liner)
      const action =
        tier === "APPROVED"
          ? "Proceed only with strict risk rules."
          : tier === "CONDITIONAL"
          ? "Proceed only with conditions: confirmation + reduced risk."
          : tier === "WAIT"
          ? "No trade now. Set alerts and reassess."
          : "Avoid. Look for a higher-quality setup.";

      return { tier, score: Math.round(score), why, action, reasons, conf: Math.round(conf) };
    }

    function clamp(n, min, max){ return Math.max(min, Math.min(max, Number(n || 0))); }

    function paintBanner(v){
      const banner = document.getElementById("decisionBanner");
      const icon = document.getElementById("bannerIcon");
      const title = document.getElementById("bannerTitle");
      const sub = document.getElementById("bannerSub");

      const tier = v.tier;

      banner.classList.remove("b-ok","b-cond","b-wait","b-bad");

      if (tier === "APPROVED"){
        banner.classList.add("b-ok");
        icon.textContent = "✓";
        title.textContent = "APPROVED (DESK-GRADE)";
      } else if (tier === "CONDITIONAL"){
        banner.classList.add("b-cond");
        icon.textContent = "!";
        title.textContent = "CONDITIONAL (CONFIRM FIRST)";
      } else if (tier === "WAIT"){
        banner.classList.add("b-wait");
        icon.textContent = "⏸";
        title.textContent = "WAIT (EDGE NOT CLEAR)";
      } else {
        banner.classList.add("b-bad");
        icon.textContent = "×";
        title.textContent = "REJECTED (DO NOT EXECUTE)";
      }

      const line = `${v.why} ${v.action}`;
      sub.textContent = line;
    }

    function renderChecks(n){
      const checksList = document.getElementById("checksList");
      checksList.innerHTML = "";

      // Use market_context as structured checks
      const mc = n.mc || {};
      const entries = [];

      if (mc.structure) entries.push({ label:"Context • Structure", detail: String(mc.structure), level: "" });
      if (mc.liquidity) entries.push({ label:"Context • Liquidity", detail: String(mc.liquidity), level: "" });
      if (mc.momentum) entries.push({ label:"Context • Momentum", detail: String(mc.momentum), level: "" });
      if (mc.timeframe_alignment) entries.push({ label:"Context • Timeframe Alignment", detail: String(mc.timeframe_alignment), level: "" });

      // Invalidation warnings are desk-grade checks (always prominent)
      if (Array.isArray(n.invalidations) && n.invalidations.length){
        for (const w of n.invalidations.slice(0, 6)){
          entries.unshift({ label:"Invalidation Warning", detail: String(w), level: "High risk" });
        }
      }

      if (!entries.length){
        addRow(checksList, "Checks", "No structured checks returned.", "");
        return;
      }

      for (const it of entries){
        addRow(checksList, it.label, it.detail || "—", it.level || "");
      }
    }

    function renderSnapshot(n){
      const snapshotList = document.getElementById("snapshotList");
      snapshotList.innerHTML = "";

      // Show the fields that matter in a report (institutional formatting)
      addRow(snapshotList, "Pair Type", fmt(n.pair || "—"), "");
      addRow(snapshotList, "Timeframe", fmt(n.timeframe || "—"), "");
      addRow(snapshotList, "Direction", fmt(n.direction || "—"), "");

      if (n.entry) addRow(snapshotList, "Entry", fmt(n.entry), "");
      if (n.stop) addRow(snapshotList, "Stop Loss", fmt(n.stop), "");
      if (n.targets) addRow(snapshotList, "Targets", fmt(n.targets), "");
      if (n.rr !== null && n.rr !== undefined) addRow(snapshotList, "R:R", Number(n.rr).toFixed(2), "");

      // Confidence/Strength/Clarity are also part of the snapshot
      addRow(snapshotList, "AI Confidence", `${Math.round(n.confidence)}%`, "");
      if (isFinite(n.strength)) addRow(snapshotList, "Strength", fmt(n.strength), "");
      if (isFinite(n.clarity)) addRow(snapshotList, "Clarity", fmt(n.clarity), "");
    }

    function buildReasoning(n, verdictObj){
      // Build a meaningful narrative even if backend doesn’t send a single "analysis text"
      const lines = [];

      lines.push("Institutional Summary");
      lines.push(`• Verdict: ${verdictObj.tier} (Edge Score: ${verdictObj.score}/100)`);
      lines.push(`• Basis: ${verdictObj.reasons.join(" • ")}`);

      // Signal check
      lines.push("");
      lines.push("Signal Check");
      lines.push(`• Direction: ${fmt(n.direction)}`);
      lines.push(`• Entry: ${fmt(n.entry)}`);
      lines.push(`• Stop Loss: ${fmt(n.stop)}`);
      lines.push(`• Targets: ${fmt(n.targets)}`);
      lines.push(`• Approx RR: ${n.rr !== null ? Number(n.rr).toFixed(2) : "—"}`);

      // Market context
      const mc = n.mc || {};
      lines.push("");
      lines.push("Market Context");
      lines.push(`• Structure: ${fmt(mc.structure)}`);
      lines.push(`• Liquidity: ${fmt(mc.liquidity)}`);
      lines.push(`• Momentum: ${fmt(mc.momentum)}`);
      lines.push(`• Timeframe alignment: ${fmt(mc.timeframe_alignment)}`);

      // Invalidation warnings
      if (Array.isArray(n.invalidations) && n.invalidations.length){
        lines.push("");
        lines.push("Invalidation Warnings (desk-grade)");
        for (const w of n.invalidations.slice(0, 6)){
          lines.push(`• ${fmt(w)}`);
        }
      }

      // Why + Guidance (if available)
      if (Array.isArray(n.why) && n.why.length){
        lines.push("");
        lines.push("Why This Trade");
        for (const w of n.why.slice(0, 7)){
          lines.push(`• ${fmt(w)}`);
        }
      }

      if (n.raw?.analysis?.verdict){
        lines.push("");
        lines.push("Model Verdict Notes");
        lines.push(fmt(n.raw.analysis.verdict));
      }

      if (Array.isArray(n.guidance) && n.guidance.length){
        lines.push("");
        lines.push("Execution Guidance");
        for (const g of n.guidance.slice(0, 7)){
          lines.push(`• ${fmt(g)}`);
        }
      }

      // Always include the original signal for auditability
      if (n.signal){
        lines.push("");
        lines.push("Original Input");
        lines.push(n.signal);
      }

      return lines.join("\n");
    }

    function render(n){
      // Meta
      document.getElementById("metaLine").textContent = `Generated — ${nowStamp(n.generatedAt)}`;

      // Institutional verdict
      const v = institutionalVerdict(n);
      paintBanner(v);

      // KPIs
      document.getElementById("kpiPair").textContent = fmt(n.pair);
      document.getElementById("kpiTf").textContent = `Timeframe: ${fmt(n.timeframe)}`;
      document.getElementById("kpiSide").textContent = safeUpper(n.direction || "—");
      document.getElementById("kpiBias").textContent = `Bias: ${fmt(n.mc?.structure || n.raw?.analysis?.bias || "—")}`;
      document.getElementById("kpiScore").textContent = `${v.score}/100`;
      document.getElementById("kpiParts").textContent = `Confidence: ${v.conf}% • RR: ${n.rr !== null ? Number(n.rr).toFixed(2) : "—"}`;

      // Snapshot + Checks
      renderSnapshot(n);
      renderChecks(n);

      // Reasoning
      const analysisBox = document.getElementById("analysisBox");
      analysisBox.textContent = buildReasoning(n, v);

      // Copy payload
      window.__fxco_copy = {
        tier: v.tier,
        score: v.score,
        confidence: v.conf,
        rr: n.rr,
        pair: n.pair,
        timeframe: n.timeframe,
        direction: n.direction,
        reasoning: analysisBox.textContent
      };
    }

    // Actions
    document.getElementById("btnBack").addEventListener("click", () => history.back());
    document.getElementById("btnNew").addEventListener("click", () => window.location.href = "/");
    document.getElementById("btnPrint").addEventListener("click", () => window.print());

    document.getElementById("btnCopy").addEventListener("click", async () => {
      try{
        const d = window.__fxco_copy || {};
        const out =
`FXCO-Pilot Trade Validation Report
Institutional Verdict: ${fmt(d.tier)} (Edge Score: ${fmt(d.score)}/100)
Confidence: ${fmt(d.confidence)}%
RR: ${d.rr !== null && d.rr !== undefined ? Number(d.rr).toFixed(2) : "—"}

Instrument: ${fmt(d.pair)}
Timeframe: ${fmt(d.timeframe)}
Direction: ${fmt(d.direction)}

Reasoning:
${fmt(d.reasoning)}`.trim();

        await navigator.clipboard.writeText(out);
        const btn = document.getElementById("btnCopy");
        const old = btn.textContent;
        btn.textContent = "Copied ✓";
        setTimeout(() => btn.textContent = old, 1100);
      } catch(e){
        alert("Copy failed. Your browser may block clipboard access.");
      }
    });

    // Load report from sessionStorage
    (function init(){
      const raw = sessionStorage.getItem("fxcoReport");
      if (!raw){
        render(normalize({
          pair_type: "—",
          timeframe: "—",
          signal_input: "",
          analysis: {
            confidence: 0,
            strength: 0,
            clarity: 0,
            verdict: "No report found",
            guidance: [
              "No validation data was found in this session.",
              "Go back and analyze a trade to generate a new report."
            ]
          },
          generated_at: Date.now()
        }));
        return;
      }

      try{
        const parsed = JSON.parse(raw);
        render(normalize(parsed));
      } catch(e){
        // If it wasn't JSON, render as fallback
        render(normalize({
          pair_type: "—",
          timeframe: "—",
          signal_input: "",
          analysis: { verdict: "Unknown", guidance: [String(raw)] },
          generated_at: Date.now()
        }));
      }
    })();
  </script>
</body>
</html>
