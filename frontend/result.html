<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FXCO-Pilot — Trade Validation Report</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#f7f9ff;
      --bg2:#ffffff;
      --ink:#0b1220;
      --muted:#5c667a;
      --line:rgba(15, 23, 42, .10);
      --shadow: 0 18px 60px rgba(15, 23, 42, .08);
      --shadow2: 0 10px 30px rgba(15, 23, 42, .08);
      --radius: 18px;
      --radius2: 14px;

      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --info:#3b82f6;

      --btn:#0b1220;
      --btnInk:#ffffff;
      --btn2:#ffffff;
      --btn2Ink:#0b1220;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body{
      margin:0;
      font-family: Poppins, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--ink);
      background:
        radial-gradient(1200px 500px at 15% 10%, rgba(14,165,233,.10), transparent 60%),
        radial-gradient(900px 450px at 85% 0%, rgba(34,197,94,.10), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
    }

    a { color: inherit; text-decoration: none; }

    .wrap{
      max-width: 1120px;
      margin: 0 auto;
      padding: 26px 18px 64px;
    }

    /* Top bar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 8px 4px 18px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
    }

    .mark{
      width: 38px; height: 38px;
      border-radius: 12px;
      background:
        radial-gradient(12px 12px at 30% 30%, rgba(255,255,255,.8), transparent 55%),
        linear-gradient(135deg, rgba(14,165,233,.95), rgba(34,197,94,.90));
      box-shadow: 0 10px 30px rgba(14,165,233,.18);
      border: 1px solid rgba(255,255,255,.6);
    }

    .brand h1{
      font-size: 14px;
      margin:0;
      letter-spacing: .2px;
      font-weight: 700;
      line-height: 1.1;
    }
    .brand p{
      margin:2px 0 0;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.1;
    }

    .actions{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .btn{
      border: 1px solid var(--line);
      background: var(--btn2);
      color: var(--btn2Ink);
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 700;
      box-shadow: 0 10px 22px rgba(15,23,42,.06);
      cursor: pointer;
      transition: transform .12s ease, box-shadow .12s ease;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      user-select: none;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 14px 28px rgba(15,23,42,.09); }
    .btn.primary{
      background: var(--btn);
      color: var(--btnInk);
      border-color: rgba(255,255,255,.08);
      box-shadow: 0 16px 40px rgba(11,18,32,.20);
    }

    /* Hero */
    .hero{
      margin-top: 6px;
      border-radius: var(--radius);
      background: rgba(255,255,255,.82);
      border: 1px solid rgba(255,255,255,.55);
      box-shadow: var(--shadow);
      padding: 18px;
      backdrop-filter: blur(10px);
    }

    .heroGrid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap: 14px;
      align-items: start;
    }
    @media (max-width: 900px){
      .heroGrid{ grid-template-columns: 1fr; }
    }

    .titleRow{
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .hero h2{
      margin:0;
      font-size: 18px;
      letter-spacing: .2px;
      font-weight: 800;
    }

    .sub{
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.6;
    }

    /* DECISION BANNER */
    .decisionBanner{
      margin-top: 12px;
      border-radius: 16px;
      border: 1px solid rgba(15,23,42,.10);
      padding: 14px;
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 12px;
    }

    .decisionLeft{
      display:flex;
      gap: 12px;
      align-items:flex-start;
      min-width: 0;
    }

    .decisionIcon{
      width: 38px;
      height: 38px;
      border-radius: 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 18px;
      font-weight: 900;
      color: #fff;
      flex: 0 0 auto;
      box-shadow: 0 14px 28px rgba(15,23,42,.12);
    }

    .decisionTitle{
      margin:0;
      font-size: 14px;
      font-weight: 900;
      letter-spacing: .2px;
      line-height: 1.2;
      word-break: break-word;
    }

    .decisionMeaning{
      margin: 6px 0 0;
      font-size: 12px;
      color: rgba(15,23,42,.78);
      line-height: 1.55;
    }

    .decisionTag{
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      font-weight: 900;
      letter-spacing: .2px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.75);
      white-space: nowrap;
      display:inline-flex;
      align-items:center;
      gap: 8px;
    }

    .dot{
      width: 9px; height: 9px;
      border-radius: 999px;
      display:inline-block;
    }

    .banner-good{ background: linear-gradient(180deg, rgba(34,197,94,.12), rgba(34,197,94,.06)); }
    .banner-warn{ background: linear-gradient(180deg, rgba(245,158,11,.14), rgba(245,158,11,.06)); }
    .banner-bad { background: linear-gradient(180deg, rgba(239,68,68,.14), rgba(239,68,68,.06)); }
    .banner-neutral{ background: linear-gradient(180deg, rgba(14,165,233,.10), rgba(14,165,233,.05)); }

    .icon-good{ background: linear-gradient(135deg, rgba(34,197,94,1), rgba(16,185,129,1)); }
    .icon-warn{ background: linear-gradient(135deg, rgba(245,158,11,1), rgba(251,191,36,1)); }
    .icon-bad { background: linear-gradient(135deg, rgba(239,68,68,1), rgba(244,63,94,1)); }
    .icon-neutral{ background: linear-gradient(135deg, rgba(14,165,233,1), rgba(59,130,246,1)); }

    /* KPI cards */
    .kpis{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 12px;
    }
    @media (max-width: 700px){
      .kpis{ grid-template-columns: 1fr; }
    }

    .kpi{
      border-radius: var(--radius2);
      border: 1px solid var(--line);
      background: rgba(255,255,255,.65);
      padding: 12px;
      box-shadow: var(--shadow2);
    }
    .kpi .label{
      color: var(--muted);
      font-size: 11px;
      margin:0 0 6px;
      font-weight: 600;
      letter-spacing: .2px;
      text-transform: uppercase;
    }
    .kpi .value{
      margin:0;
      font-size: 14px;
      font-weight: 900;
      letter-spacing: .2px;
    }

    /* Layout below */
    .grid{
      display:grid;
      grid-template-columns: .95fr 1.05fr;
      gap: 14px;
      margin-top: 14px;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border-radius: var(--radius);
      background: rgba(255,255,255,.86);
      border: 1px solid rgba(255,255,255,.55);
      box-shadow: var(--shadow2);
      padding: 16px;
      backdrop-filter: blur(10px);
    }

    .card h3{
      margin:0 0 10px;
      font-size: 14px;
      font-weight: 900;
      letter-spacing: .2px;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .row{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.65);
      border-radius: 14px;
      padding: 12px;
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 10px;
    }

    .row .left{ min-width: 0; }
    .row .key{
      font-size: 11px;
      color: var(--muted);
      margin:0 0 4px;
      font-weight: 800;
      letter-spacing: .2px;
      text-transform: uppercase;
    }
    .row .val{
      margin:0;
      font-size: 13px;
      font-weight: 700;
      word-wrap: break-word;
    }

    .chip{
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 11px;
      font-weight: 900;
      border: 1px solid var(--line);
      background: rgba(15,23,42,.04);
      white-space: nowrap;
    }
    .chip.good{ background: rgba(34,197,94,.10); border-color: rgba(34,197,94,.20); }
    .chip.warn{ background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.22); }
    .chip.bad{ background: rgba(239,68,68,.12); border-color: rgba(239,68,68,.22); }

    /* AI Reasoning block (not silent anymore) */
    .analysis{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.65);
      border-radius: 14px;
      padding: 14px;
      line-height: 1.75;
      color: #0b1220;
      font-size: 13px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .callout{
      margin-bottom: 10px;
      border-radius: 14px;
      border: 1px solid rgba(59,130,246,.18);
      background: rgba(59,130,246,.08);
      padding: 10px 12px;
      font-size: 12px;
      line-height: 1.55;
      color: rgba(15,23,42,.86);
    }
    .callout b{ font-weight: 900; }

    .muted{ color: var(--muted); font-size: 12px; line-height: 1.65; }

    .foot{
      margin-top: 12px;
      color: var(--muted);
      font-size: 11px;
      line-height: 1.6;
      text-align: center;
      padding: 10px 6px 0;
    }

    @media print{
      .topbar .actions{ display:none; }
      body{ background: #fff; }
      .hero, .card{ box-shadow: none; border: 1px solid #ddd; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="mark"></div>
        <div>
          <h1>FXCO-Pilot</h1>
          <p>AI Trade Validator • Report</p>
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="btnBack">← Back</button>
        <button class="btn" id="btnCopy">Copy Summary</button>
        <button class="btn" id="btnPrint">Print</button>
        <button class="btn primary" id="btnNew">New Validation</button>
      </div>
    </div>

    <section class="hero">
      <div class="heroGrid">
        <div>
          <div class="titleRow">
            <div>
              <h2>Trade Validation Report</h2>
              <p class="sub" id="metaLine">Generated —</p>
            </div>

            <div class="decisionTag" id="verdictBadge">
              <span class="dot" id="verdictDot"></span>
              <span id="verdictText">—</span>
            </div>
          </div>

          <div class="decisionBanner banner-neutral" id="decisionBanner">
            <div class="decisionLeft">
              <div class="decisionIcon icon-neutral" id="decisionIcon">↔</div>
              <div style="min-width:0;">
                <p class="decisionTitle" id="decisionTitle">NEUTRAL / NEEDS MORE CONFIRMATION</p>
                <p class="decisionMeaning" id="decisionMeaning">
                  The signal is not clear enough yet. Wait for better confirmation (structure + timing + liquidity).
                </p>
              </div>
            </div>
          </div>

          <div class="kpis">
            <div class="kpi">
              <p class="label">Pair</p>
              <p class="value" id="kpiPair">—</p>
            </div>
            <div class="kpi">
              <p class="label">Direction</p>
              <p class="value" id="kpiSide">—</p>
            </div>
            <div class="kpi">
              <p class="label">Risk</p>
              <p class="value" id="kpiRisk">—</p>
            </div>
          </div>

          <p class="muted" style="margin: 12px 2px 0;">
            This report is decision support — not a signal. It evaluates context, risk, and assumptions before execution.
          </p>
        </div>

        <div>
          <div class="card" style="padding: 14px;">
            <h3 style="margin-bottom: 10px;">Snapshot</h3>
            <div class="list" id="snapshotList"></div>
          </div>
        </div>
      </div>
    </section>

    <div class="grid">
      <section class="card">
        <h3>Key Checks</h3>
        <div class="list" id="checksList"></div>
        <p class="muted" style="margin: 12px 2px 0;">
          Tip: If a check looks “Warn” or “High risk”, tighten the plan (SL placement, confluence, timing) before entry.
        </p>
      </section>

      <section class="card">
        <h3>AI Reasoning</h3>
        <div class="analysis" id="analysisBox">Loading…</div>
      </section>
    </div>

    <div class="foot">
      FXCO-Pilot helps you validate decisions before execution. Always confirm on your chart and follow your plan.
    </div>
  </div>

  <script>
    function fmt(v){
      if (v === null || v === undefined || v === "") return "—";
      return String(v);
    }

    function safeUpper(v){
      return fmt(v).toUpperCase();
    }

    function escHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
      }[m]));
    }

    function stampFrom(ts){
      const n = Number(ts);
      const d = isFinite(n) ? new Date(n) : new Date();
      return d.toLocaleString(undefined, { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }

    function pick(obj, keys){
      for (const k of keys){
        if (obj && obj[k] !== undefined && obj[k] !== null && String(obj[k]).trim() !== "") return obj[k];
      }
      return "";
    }

    function chipClass(level){
      const v = (level || "").toLowerCase();
      if (v.includes("good") || v.includes("low") || v.includes("pass") || v.includes("ok")) return "chip good";
      if (v.includes("warn") || v.includes("medium") || v.includes("caution")) return "chip warn";
      if (v.includes("bad") || v.includes("high") || v.includes("fail") || v.includes("risk")) return "chip bad";
      return "chip";
    }

    function addRow(container, key, val, chip){
      const el = document.createElement("div");
      el.className = "row";
      el.innerHTML = `
        <div class="left">
          <p class="key">${escHtml(key)}</p>
          <p class="val">${escHtml(val)}</p>
        </div>
        ${chip ? `<span class="${chipClass(chip)}">${escHtml(chip)}</span>` : ""}
      `;
      container.appendChild(el);
    }

    function setVerdictBadge(v){
      const dot = document.getElementById("verdictDot");
      const text = document.getElementById("verdictText");

      const verdict = (v || "").toLowerCase();

      let label = "NO VERDICT";
      let dotColor = "rgba(15,23,42,.35)";

      if (verdict.includes("take") || verdict.includes("approve") || verdict.includes("valid") || verdict.includes("yes") || verdict.includes("ok")){
        label = "APPROVED";
        dotColor = "rgba(34,197,94,.95)";
      } else if (verdict.includes("neutral") || verdict.includes("wait") || verdict.includes("unclear")){
        label = "NEUTRAL";
        dotColor = "rgba(14,165,233,.95)";
      } else if (verdict.includes("caution") || verdict.includes("warn") || verdict.includes("reduce")){
        label = "CAUTION";
        dotColor = "rgba(245,158,11,.95)";
      } else if (verdict.includes("avoid") || verdict.includes("reject") || verdict.includes("no")){
        label = "REJECTED";
        dotColor = "rgba(239,68,68,.95)";
      }

      dot.style.background = dotColor;
      text.textContent = label;
    }

    function setDecisionBanner(decisionRaw){
      const banner = document.getElementById("decisionBanner");
      const icon = document.getElementById("decisionIcon");
      const title = document.getElementById("decisionTitle");
      const meaning = document.getElementById("decisionMeaning");

      const d = String(decisionRaw || "").toUpperCase();

      banner.className = "decisionBanner banner-neutral";
      icon.className = "decisionIcon icon-neutral";
      icon.textContent = "↔";
      title.textContent = "NEUTRAL / NEEDS MORE CONFIRMATION";
      meaning.textContent = "The signal is not clear enough yet. Wait for better confirmation (structure + timing + liquidity).";

      if (d.includes("TAKE") || d.includes("BUY") || d.includes("LONG") || d.includes("APPROVE")){
        banner.className = "decisionBanner banner-good";
        icon.className = "decisionIcon icon-good";
        icon.textContent = "✓";
        title.textContent = "TAKE TRADE (APPROVED)";
        meaning.textContent = "Conditions look aligned. If your plan matches this setup, execute with strict risk control (SL and position size).";
        return;
      }

      if (d.includes("AVOID") || d.includes("REJECT") || d.includes("NO TRADE")){
        banner.className = "decisionBanner banner-bad";
        icon.className = "decisionIcon icon-bad";
        icon.textContent = "✕";
        title.textContent = "AVOID TRADE (REJECTED)";
        meaning.textContent = "Too many invalidation risks. Best decision is to stand down or wait for a cleaner setup.";
        return;
      }

      if (d.includes("CAUTION") || d.includes("RISKY") || d.includes("REDUCE")){
        banner.className = "decisionBanner banner-warn";
        icon.className = "decisionIcon icon-warn";
        icon.textContent = "!";
        title.textContent = "CAUTION (TIGHTEN YOUR PLAN)";
        meaning.textContent = "Setup has mixed signals. Reduce risk, demand stronger confirmation, or wait for a better entry.";
        return;
      }
    }

    function flattenContextToBullets(contextObj){
      if (!contextObj || typeof contextObj !== "object") return [];
      const out = [];
      for (const [k,v] of Object.entries(contextObj)){
        const key = String(k).replace(/_/g, " ");
        const val = String(v || "").trim();
        if (!val) continue;
        out.push(`${key}: ${val}`);
      }
      return out;
    }

    function buildReasoning(report){
      // 1) Prefer real text if backend sends it
      const rawText = (typeof report.analysis === "string") ? report.analysis.trim() : "";
      if (rawText) return rawText;

      // 2) Otherwise: generate a summary from what we DO have
      const a = (report.raw && report.raw.analysis && typeof report.raw.analysis === "object") ? report.raw.analysis : {};
      const decision = String(report.decision || "").toUpperCase();
      const dir = safeUpper(report.side);
      const conf = pick(a, ["confidence","ai_confidence","score"]);
      const rr = pick(a, ["approx_rr","rr","risk_reward"]);
      const verdictLine = pick(a, ["verdict"]) || pick(report.raw, ["verdict"]) || "";

      const why = Array.isArray(a.why_this_trade) ? a.why_this_trade.filter(Boolean) : [];
      const guidance = Array.isArray(a.guidance) ? a.guidance.filter(Boolean) : [];

      // Market context can be under analysis.market_context
      const ctx = (a.market_context && typeof a.market_context === "object") ? a.market_context : null;
      const ctxBullets = flattenContextToBullets(ctx);

      // Also pull “checks list” content into bullets (top few) for readability
      const checkBullets = [];
      const checks = Array.isArray(report.checks) ? report.checks : [];
      for (const item of checks){
        if (typeof item === "string") {
          checkBullets.push(item);
        } else if (item && typeof item === "object") {
          const label = fmt(item.label ?? item.name ?? item.key ?? "Check");
          const detail = fmt(item.detail ?? item.value ?? item.message ?? "");
          if (detail && detail !== "—") checkBullets.push(`${label}: ${detail}`);
        }
        if (checkBullets.length >= 6) break;
      }

      const lines = [];
      lines.push(`Summary`);
      lines.push(`- Decision: ${decision || "—"}`);
      if (dir && dir !== "—") lines.push(`- Direction: ${dir}`);
      if (conf) lines.push(`- Confidence: ${conf}`);
      if (rr) lines.push(`- Approx R:R: ${rr}`);
      if (verdictLine) lines.push(`- Verdict note: ${verdictLine}`);

      const evidence = [];
      for (const b of ctxBullets.slice(0, 6)) evidence.push(b);
      for (const b of checkBullets.slice(0, 6)) evidence.push(b);

      if (evidence.length) {
        lines.push(`\nEvidence seen`);
        for (const b of evidence.slice(0, 8)) lines.push(`- ${b}`);
      }

      if (why.length) {
        lines.push(`\nWhy this decision`);
        for (const b of why.slice(0, 8)) lines.push(`- ${b}`);
      }

      if (guidance.length) {
        lines.push(`\nGuidance`);
        for (const b of guidance.slice(0, 10)) lines.push(`- ${b}`);
      }

      // Hard fallback so it never looks empty
      if (lines.length <= 3){
        lines.push(`\nNo detailed reasoning text was returned by the server.`);
        lines.push(`FXCO-Pilot generated this summary from the available context fields.`);
      }

      return lines.join("\n");
    }

    function normalizeFromIndexPayload(payload){
      const p = payload || {};
      const a = (p.analysis && typeof p.analysis === "object") ? p.analysis : {};

      const decision = pick(a, ["decision","verdict","final_verdict","recommendation"]) ||
                       pick(p, ["decision","verdict","status"]) || "";

      const direction = pick(a, ["direction","bias","side"]) || "";
      const risk = pick(a, ["risk","risk_level","riskLevel","risk_summary"]) || "";
      const pair = pick(a, ["pair","symbol","instrument"]) || pick(p, ["pair","pair_type"]) || "";

      const entry = pick(a, ["entry","entry_price"]);
      const sl = pick(a, ["stop_loss","sl"]);
      const tp = pick(a, ["take_profit","tp","target","targets"]);
      const rr = pick(a, ["rr","risk_reward","riskReward","approx_rr"]);

      const snapshot = {};
      if (pick(p, ["pair_type"])) snapshot["Pair Type"] = p.pair_type;
      if (pick(p, ["timeframe"])) snapshot["Timeframe"] = p.timeframe;
      if (direction) snapshot["Direction"] = direction;
      if (entry) snapshot["Entry"] = entry;
      if (sl) snapshot["Stop Loss"] = sl;
      if (tp) snapshot["Take Profit / Targets"] = tp;
      if (rr) snapshot["Approx R:R"] = rr;

      const conf = pick(a, ["confidence","ai_confidence","score"]);
      const strength = pick(a, ["strength"]);
      const clarity = pick(a, ["clarity"]);
      if (conf) snapshot["AI Confidence"] = conf;
      if (strength) snapshot["Strength"] = strength;
      if (clarity) snapshot["Clarity"] = clarity;

      let checks = [];
      const maybeChecks = pick(a, ["checks","key_checks","rules"]);
      if (Array.isArray(maybeChecks)) checks = maybeChecks;

      // Also push market_context into checks list (so it shows even if checks are missing)
      const ctx = a.market_context && typeof a.market_context === "object" ? a.market_context : null;
      if (ctx) {
        const ctxPairs = Object.entries(ctx).filter(([k,v]) => v !== null && v !== undefined && String(v).trim() !== "");
        for (const [k,v] of ctxPairs) {
          checks.push({ label: "Context • " + String(k).replace(/_/g," "), detail: String(v), level: "" });
        }
      }

      const analysisText = pick(a, ["reasoning","analysis_text","summary","explanation"]) || "";

      return {
        decision,
        verdictBadge: decision,
        analysis: analysisText,
        pair,
        side: direction,
        risk,
        snapshot,
        checks,
        generated_at: pick(p, ["generated_at"]) || Date.now(),
        raw: payload
      };
    }

    function parseReport(raw){
      if (!raw) return normalizeFromIndexPayload({});
      if (typeof raw === "string") return normalizeFromIndexPayload({ analysis: { decision: "NEUTRAL", summary: raw } });

      if (raw && (raw.pair_type !== undefined || raw.signal_input !== undefined || (raw.analysis && typeof raw.analysis === "object"))) {
        return normalizeFromIndexPayload(raw);
      }

      const decision = raw.decision ?? raw.verdict ?? raw.status ?? "";
      return {
        decision,
        verdictBadge: decision,
        analysis: raw.analysis ?? raw.reasoning ?? raw.result ?? raw.message ?? "",
        pair: raw.pair ?? raw.symbol ?? raw.instrument ?? "",
        side: raw.side ?? raw.direction ?? raw.bias ?? "",
        risk: raw.risk ?? raw.risk_summary ?? raw.riskLevel ?? "",
        snapshot: raw.snapshot ?? {},
        checks: raw.checks ?? raw.key_checks ?? raw.rules ?? [],
        generated_at: raw.generated_at || Date.now(),
        raw
      };
    }

    function render(report){
      document.getElementById("metaLine").textContent = `Generated — ${stampFrom(report.generated_at)}`;

      document.getElementById("kpiPair").textContent = fmt(report.pair || report.raw?.pair_type || "—");
      document.getElementById("kpiSide").textContent = safeUpper(report.side);
      document.getElementById("kpiRisk").textContent = fmt(report.risk);

      setDecisionBanner(report.decision);
      setVerdictBadge(report.verdictBadge);

      const snapshotList = document.getElementById("snapshotList");
      snapshotList.innerHTML = "";

      const snap = report.snapshot || {};
      const snapEntries = Object.entries(snap).filter(([k,v]) => v !== null && v !== undefined && String(v).trim() !== "");

      if (snapEntries.length === 0){
        addRow(snapshotList, "Snapshot", "No snapshot fields returned.", "");
      } else {
        for (const [k,v] of snapEntries){
          addRow(snapshotList, k, fmt(v), "");
        }
      }

      const checksList = document.getElementById("checksList");
      checksList.innerHTML = "";

      const checks = Array.isArray(report.checks) ? report.checks : [];
      if (checks.length === 0){
        addRow(checksList, "Checks", "No structured checks returned. See AI reasoning.", "");
      } else {
        for (const item of checks){
          if (typeof item === "string"){
            addRow(checksList, "Check", item, "");
          } else {
            const label = fmt(item.label ?? item.name ?? item.key ?? "Check");
            const detail = fmt(item.detail ?? item.value ?? item.message ?? "");
            const level = fmt(item.level ?? item.status ?? item.risk ?? "");
            addRow(checksList, label, detail || "—", level || "");
          }
        }
      }

      const analysisBox = document.getElementById("analysisBox");
      const reasoning = buildReasoning(report);

      // If backend didn't send reasoning, show a small callout so users trust it
      const backendSentText = (typeof report.analysis === "string") && report.analysis.trim().length > 0;
      const callout = backendSentText ? "" : `
        <div class="callout">
          <b>Reasoning Summary:</b> The server did not return a long-form explanation, so FXCO-Pilot generated this readable summary from your context + checks.
        </div>
      `;

      analysisBox.innerHTML = callout + `<div>${escHtml(reasoning)}</div>`;

      window.__fxco_copy = {
        decision: report.decision,
        pair: report.pair || report.raw?.pair_type || "",
        side: report.side,
        risk: report.risk,
        analysis: reasoning
      };
    }

    function getStoredReportRaw(){
      try {
        const s = sessionStorage.getItem("fxcoReport");
        if (s) return s;
      } catch {}

      try {
        const l = localStorage.getItem("fxcoReport_last_v1");
        if (l) return l;
      } catch {}

      return "";
    }

    function goBackSmart(){
      if (window.history.length <= 1) {
        window.location.href = "/";
        return;
      }
      history.back();
    }

    document.getElementById("btnBack").addEventListener("click", goBackSmart);
    document.getElementById("btnNew").addEventListener("click", () => window.location.href = "/");
    document.getElementById("btnPrint").addEventListener("click", () => window.print());

    document.getElementById("btnCopy").addEventListener("click", async () => {
      try{
        const d = window.__fxco_copy || {};
        const out =
`FXCO-Pilot Trade Validation Report
Decision: ${fmt(d.decision)}
Pair: ${fmt(d.pair)}
Direction: ${fmt(d.side)}
Risk: ${fmt(d.risk)}

Notes:
${fmt(d.analysis)}`.trim();

        await navigator.clipboard.writeText(out);
        const btn = document.getElementById("btnCopy");
        const old = btn.textContent;
        btn.textContent = "Copied ✓";
        setTimeout(() => btn.textContent = old, 1100);
      } catch(e){
        alert("Copy failed. Your browser may block clipboard access.");
      }
    });

    (function init(){
      const raw = getStoredReportRaw();

      if (!raw){
        render(parseReport({
          analysis: { decision: "NEUTRAL", summary: "No validation data was found. Go back and analyze a trade to generate a new report." },
          generated_at: Date.now()
        }));
        return;
      }

      try{
        const parsed = JSON.parse(raw);
        try { sessionStorage.setItem("fxcoReport", JSON.stringify(parsed)); } catch {}
        render(parseReport(parsed));
      } catch(e){
        render(parseReport(raw));
      }
    })();
  </script>
</body>
</html>
